# Makefile.toml for Reinhardt Project
#
# This file provides cargo-make task definitions for common development operations.
# Install cargo-make: `cargo install cargo-make`
# Usage: `cargo make <task>`

[config]
default_to_workspace = false
skip_core_tasks = true

# ============================================================================
# Environment Variables
# ============================================================================

[env]
# Use local target directory for each example (independent from workspace)
CARGO_TARGET_DIR = { value = "target", condition = { env_not_set = ["CARGO_TARGET_DIR"] } }

# ============================================================================
# Development Server
# ============================================================================

[tasks.runserver]
description = "Start the development server"
command = "cargo"
args = ["run", "runserver"]

[tasks.runserver-watch]
description = "Start the development server with auto-reload (requires bacon)"
command = "bacon"
args = ["runserver"]

# ============================================================================
# Database Migrations
# ============================================================================

[tasks.makemigrations]
description = "Create new migrations based on model changes"
command = "cargo"
args = ["run", "--bin", "examples-twitter", "makemigrations"]

[tasks.makemigrations-app]
description = "Create new migrations for a specific app (usage: cargo make makemigrations-app -- <app_label>)"
command = "cargo"
args = ["run", "--bin", "examples-twitter", "makemigrations", "${@}"]

[tasks.migrate]
description = "Apply database migrations"
command = "cargo"
args = ["run", "--bin", "examples-twitter", "migrate"]

# ============================================================================
# Static Files
# ============================================================================

[tasks.collectstatic]
description = "Collect static files into STATIC_ROOT"
command = "cargo"
args = ["run", "--bin", "examples-twitter", "collectstatic"]

# ============================================================================
# Project Management
# ============================================================================

[tasks.check]
description = "Check the project for common issues"
command = "cargo"
args = ["run", "--bin", "examples-twitter", "check"]

[tasks.showurls]
description = "Display all registered URL patterns"
command = "cargo"
args = ["run", "--bin", "examples-twitter", "showurls"]

[tasks.shell]
description = "Run an interactive Rust shell (REPL)"
command = "cargo"
args = ["run", "--bin", "examples-twitter", "shell"]

# ============================================================================
# Testing
# ============================================================================

[tasks.test]
description = "Run all tests"
command = "cargo"
args = ["nextest", "run", "--all-features"]

[tasks.test-unit]
description = "Run unit tests only"
command = "cargo"
args = ["nextest", "run", "--lib", "--all-features"]

[tasks.test-integration]
description = "Run integration tests only"
command = "cargo"
args = ["nextest", "run", "--test", "*", "--all-features"]

[tasks.test-watch]
description = "Run tests with auto-reload (requires bacon)"
command = "bacon"
args = ["test"]

# ============================================================================
# Code Quality
# ============================================================================

[tasks.fmt-check]
description = "Check code formatting (rustfmt + page! DSL)"
command = "cargo"
args = ["run", "-p", "reinhardt-admin-cli", "--", "fmt", ".", "--check"]

[tasks.fmt-fix]
description = "Fix code formatting (rustfmt + page! DSL)"
command = "cargo"
args = ["run", "-p", "reinhardt-admin-cli", "--", "fmt", "."]

[tasks.clippy-check]
description = "Check linting rules"
command = "cargo"
args = ["clippy", "--all-features", "--", "-D", "warnings"]

[tasks.clippy-fix]
description = "Fix linting issues automatically"
command = "cargo"
args = ["clippy", "--all-features", "--fix", "--allow-dirty", "--allow-staged"]

[tasks.quality]
description = "Run all code quality checks (format + lint)"
dependencies = ["fmt-check", "clippy-check"]

[tasks.quality-fix]
description = "Fix all code quality issues automatically"
dependencies = ["fmt-fix", "clippy-fix"]

# ============================================================================
# Build & Clean
# ============================================================================

[tasks.build]
description = "Build the project in debug mode"
command = "cargo"
args = ["build", "--all-features"]

[tasks.build-release]
description = "Build the project in release mode"
command = "cargo"
args = ["build", "--release", "--all-features"]

[tasks.clean]
description = "Clean build artifacts"
command = "cargo"
args = ["clean"]

# ============================================================================
# WASM Testing Tasks
# ============================================================================

[tasks.wasm-test]
description = "Run WASM tests in headless Chrome"
command = "wasm-pack"
args = ["test", "--headless", "--chrome"]

[tasks.wasm-test-firefox]
description = "Run WASM tests in headless Firefox"
command = "wasm-pack"
args = ["test", "--headless", "--firefox"]

[tasks.wasm-test-debug]
description = "Run WASM tests with browser (for debugging)"
command = "wasm-pack"
args = ["test", "--chrome"]

[tasks.wasm-compile-dev]
description = "Compile WASM binary (debug mode)"
command = "cargo"
args = ["build", "--target", "wasm32-unknown-unknown"]

[tasks.wasm-bindgen-dev]
description = "Generate WASM bindings using wasm-pack (debug mode)"
command = "wasm-pack"
args = [
	"build",
	"--target", "web",
	"--out-dir", "dist-wasm",
	"--dev",
	"--no-typescript"
]
dependencies = ["wasm-compile-dev"]

[tasks.wasm-build-dev]
description = "Build WASM in debug mode and collect static files"
dependencies = ["wasm-bindgen-dev"]
script = '''
echo "Running collectstatic..."
cargo run --bin examples-twitter collectstatic --no-input
echo "‚úì WASM build and collectstatic completed"
'''

[tasks.wasm-compile-release]
description = "Compile WASM binary (release mode)"
command = "cargo"
args = ["build", "--target", "wasm32-unknown-unknown", "--release"]

[tasks.wasm-bindgen-release]
description = "Generate WASM bindings using wasm-pack (release mode)"
command = "wasm-pack"
args = [
	"build",
	"--target", "web",
	"--out-dir", "dist-wasm",
	"--release"
]
dependencies = ["wasm-compile-release"]

[tasks.wasm-finalize-release]
description = "Optimize WASM with wasm-opt and collect static files"
script = '''
# Optimize with wasm-opt if available
if command -v wasm-opt &> /dev/null; then
	echo "Running wasm-opt..."
	WASM_FILE="dist-wasm/examples_twitter_bg.wasm"
	wasm-opt -O3 -o "$WASM_FILE.opt" "$WASM_FILE"
	mv "$WASM_FILE.opt" "$WASM_FILE"
	echo "‚úì WASM optimized"
else
	echo "‚ö†Ô∏è  wasm-opt not found, skipping optimization"
fi
'''
dependencies = ["wasm-bindgen-release"]

[tasks.wasm-build-release]
description = "Build WASM in release mode with optimization and collect static files"
dependencies = ["wasm-finalize-release"]
script = '''
echo "Running collectstatic..."
cargo run --bin examples-twitter collectstatic --no-input
echo "‚úì WASM release build and collectstatic completed"
'''

[tasks.wasm-clean]
description = "Clean WASM build artifacts"
script = '''
rm -rf dist dist-wasm
echo "‚úì Cleaned WASM artifacts"
'''

[tasks.clean-cache]
description = "Clean WASM artifacts and Rust incremental build cache"
script = '''
echo "üßπ Cleaning build cache..."

# WASM artifacts
if [ -d "dist-wasm" ]; then
	rm -rf dist-wasm
	echo "  ‚úì Removed dist-wasm/"
fi

if [ -d "dist" ]; then
	rm -rf dist
	echo "  ‚úì Removed dist/"
fi

# Rust incremental build cache
if [ -d "target/debug/incremental" ]; then
	rm -rf target/debug/incremental
	echo "  ‚úì Removed target/debug/incremental/"
fi

# WASM target build cache
if [ -d "target/wasm32-unknown-unknown" ]; then
	rm -rf target/wasm32-unknown-unknown
	echo "  ‚úì Removed target/wasm32-unknown-unknown/"
fi

echo "‚ú® Build cache cleaned"
'''

# ============================================================================
# Development Workflow
# ============================================================================

[tasks.dev]
description = "Build WASM and start development server with frontend"
dependencies = ["clean-cache", "wasm-build-dev", "run-dev-server"]

[tasks.run-dev-server]
description = "Start development server with frontend (MUST run from project directory)"
script = '''
#!/bin/bash
# ÁèæÂú®„ÅÆ„Éá„Ç£„É¨„ÇØ„Éà„É™„Åå examples-twitter „Åã„ÉÅ„Çß„ÉÉ„ÇØ
CURRENT_DIR=$(basename "$PWD")
if [ "$CURRENT_DIR" != "examples-twitter" ]; then
	echo "Error: This command must be run from examples/local/examples-twitter directory"
	echo "Current directory: $PWD"
	echo "Please run: cd examples/local/examples-twitter && cargo make dev"
	exit 1
fi

echo "üöÄ Starting development server with WASM frontend..."
cargo run --bin examples-twitter -- runserver --with-pages --noreload
'''

[tasks.dev-watch]
description = "Start development with auto-reload"
dependencies = ["build", "runserver-watch"]

[tasks.dev-release]
description = "Build optimized WASM and start server"
dependencies = ["clean-cache", "wasm-build-release", "collectstatic", "run-dev-release-server"]

[tasks.run-dev-release-server]
script = '''
#!/bin/bash
echo "üöÄ Starting server with optimized WASM frontend..."
cargo run --release --bin examples-twitter -- runserver --with-pages --noreload
'''

# ============================================================================
# CI/CD Workflow
# ============================================================================

[tasks.ci]
description = "Run CI pipeline (format, lint, build, test)"
dependencies = ["fmt-check", "clippy-check", "build", "test"]

# ============================================================================
# Verbosity Control
# ============================================================================

[tasks.runserver-v]
description = "Start the development server with verbose output"
command = "cargo"
args = ["run", "--bin", "examples-twitter", "runserver", "-v"]

[tasks.runserver-vv]
description = "Start the development server with very verbose output"
command = "cargo"
args = ["run", "--bin", "examples-twitter", "runserver", "-vv"]

[tasks.runserver-vvv]
description = "Start the development server with maximum verbosity"
command = "cargo"
args = ["run", "--bin", "examples-twitter", "runserver", "-vvv"]

# ============================================================================
# Help
# ============================================================================

[tasks.help]
description = "Show available tasks"
script = '''
echo "Available tasks:"
echo "  Development:"
echo "    dev                - Build WASM + start server with frontend"
echo "    dev-release        - Build optimized WASM + start server"
echo "    dev-watch          - Development with auto-reload"
echo "    runserver          - Start the development server (API only)"
echo "    runserver-watch    - Start server with auto-reload"
echo ""
echo "  WASM:"
echo "    wasm-build-dev     - Build WASM (debug)"
echo "    wasm-build-release - Build WASM (release, optimized)"
echo "    wasm-clean         - Clean WASM artifacts"
echo ""
echo "  Database:"
echo "    makemigrations     - Create new migrations"
echo "    makemigrations-app - Create migrations for specific app"
echo "    migrate            - Apply migrations"
echo ""
echo "  Static Files:"
echo "    collectstatic      - Collect static files"
echo ""
echo "  Project Management:"
echo "    check              - Check project for issues"
echo "    showurls           - Show URL patterns"
echo "    shell              - Interactive REPL"
echo ""
echo "  Testing:"
echo "    test               - Run all tests"
echo "    test-unit          - Run unit tests"
echo "    test-integration   - Run integration tests"
echo "    test-watch         - Tests with auto-reload"
echo ""
echo "  Code Quality:"
echo "    fmt-check          - Check formatting"
echo "    fmt-fix            - Fix formatting"
echo "    clippy-check       - Check linting"
echo "    clippy-fix         - Fix linting issues"
echo "    quality            - Run all checks"
echo "    quality-fix        - Fix all issues"
echo ""
echo "  Build:"
echo "    build              - Build (debug)"
echo "    build-release      - Build (release)"
echo "    clean              - Clean artifacts"
echo "    clean-cache        - Clean WASM + Rust incremental cache"
echo ""
echo "  CI/CD:"
echo "    ci                 - Run CI pipeline"
echo ""
echo "Usage: cargo make <task>"
'''
