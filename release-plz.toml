# release-plz configuration for Reinhardt project
# Documentation: https://release-plz.ieni.dev/docs/config

[workspace]
# Changelog settings
changelog_update = true

# PR settings
# IMPORTANT: Branch prefix MUST start with "release-plz-" for native two-step release workflow.
# When release_always = false, release-plz checks if the latest commit is from a PR
# whose branch starts with "release-plz-" to determine if it should publish.
# See: https://release-plz.ieni.dev/docs/config#the-release_always-field
pr_branch_prefix = "release-plz-"
pr_labels = ["release", "automated"]
pr_name = "chore: release"

# Git release settings
git_release_enable = false
git_tag_enable = true
git_tag_name = "{{ package }}@v{{ version }}"
git_release_type = "auto"

# Publish settings
semver_check = false
publish_timeout = "10m"
dependencies_update = true

# Two-stage release workflow (native release-plz control):
# - Stage 1: Push to main → `release-plz release-pr` creates Release PR (branch: release-plz-*)
# - Stage 2: Merge Release PR → `release-plz release` detects commit from release-plz-* branch and publishes
#
# With release_always = true:
# - release-plz publishes ALL crates whose local version differs from crates.io
# - This prevents phantom version bumps from `dependencies_update = true` (see KI-5 in RELEASE_PROCESS.md)
# - Normal code pushes are unaffected since versions match crates.io
# - Only after Release PR merge will version differences trigger publishing
# See: https://release-plz.ieni.dev/docs/config#the-release_always-field
release_always = true

# Skip cargo publish verification (dev-dependencies may reference unpublished workspace crates)
publish_no_verify = true

# Main crate: only reinhardt-web gets GitHub Releases
[[package]]
name = "reinhardt-web"
git_release_enable = true
version_group = "reinhardt"

# Publishable crates (alphabetical order)
[[package]]
name = "reinhardt-admin"
version_group = "reinhardt"

[[package]]
name = "reinhardt-admin-cli"
version_group = "reinhardt"

[[package]]
name = "reinhardt-apps"
version_group = "reinhardt"

[[package]]
name = "reinhardt-auth"
version_group = "reinhardt"

[[package]]
name = "reinhardt-commands"
version_group = "reinhardt"

[[package]]
name = "reinhardt-conf"
version_group = "reinhardt"

[[package]]
name = "reinhardt-core"
version_group = "reinhardt"

[[package]]
name = "reinhardt-db"
version_group = "reinhardt"

[[package]]
name = "reinhardt-db-macros"
version_group = "reinhardt"

[[package]]
name = "reinhardt-deeplink"
version_group = "reinhardt"

[[package]]
name = "reinhardt-dentdelion"
version_group = "reinhardt"

[[package]]
name = "reinhardt-di"
version_group = "reinhardt"

[[package]]
name = "reinhardt-di-macros"
version_group = "reinhardt"

[[package]]
name = "reinhardt-dispatch"
version_group = "reinhardt"

[[package]]
name = "reinhardt-forms"
version_group = "reinhardt"

[[package]]
name = "reinhardt-graphql"
version_group = "reinhardt"

[[package]]
name = "reinhardt-graphql-macros"
version_group = "reinhardt"

[[package]]
name = "reinhardt-grpc"
version_group = "reinhardt"

[[package]]
name = "reinhardt-grpc-macros"
version_group = "reinhardt"

[[package]]
name = "reinhardt-http"
version_group = "reinhardt"

[[package]]
name = "reinhardt-i18n"
version_group = "reinhardt"

[[package]]
name = "reinhardt-macros"
version_group = "reinhardt"

[[package]]
name = "reinhardt-mail"
version_group = "reinhardt"

[[package]]
name = "reinhardt-manouche"
version_group = "reinhardt"

[[package]]
name = "reinhardt-middleware"
version_group = "reinhardt"

[[package]]
name = "reinhardt-openapi"
version_group = "reinhardt"

[[package]]
name = "reinhardt-openapi-macros"
version_group = "reinhardt"

[[package]]
name = "reinhardt-pages"
version_group = "reinhardt"

[[package]]
name = "reinhardt-pages-ast"
version_group = "reinhardt"

[[package]]
name = "reinhardt-pages-macros"
version_group = "reinhardt"

[[package]]
name = "reinhardt-query"
version_group = "reinhardt"

[[package]]
name = "reinhardt-query-macros"
version_group = "reinhardt"

[[package]]
name = "reinhardt-rest"
version_group = "reinhardt"

[[package]]
name = "reinhardt-routers-macros"
version_group = "reinhardt"

[[package]]
name = "reinhardt-server"
version_group = "reinhardt"

[[package]]
name = "reinhardt-shortcuts"
version_group = "reinhardt"

[[package]]
name = "reinhardt-tasks"
version_group = "reinhardt"

[[package]]
name = "reinhardt-test"
version_group = "reinhardt"

[[package]]
name = "reinhardt-throttling"
version_group = "reinhardt"

[[package]]
name = "reinhardt-urls"
version_group = "reinhardt"

[[package]]
name = "reinhardt-utils"
version_group = "reinhardt"

[[package]]
name = "reinhardt-views"
version_group = "reinhardt"

[[package]]
name = "reinhardt-websockets"
version_group = "reinhardt"

# Non-published packages (tests, examples, internal tools)
[[package]]
name = "reinhardt-test-support"
release = false
publish = false

[[package]]
name = "reinhardt-integration-tests"
release = false
publish = false

[[package]]
name = "reinhardt-benchmarks"
release = false
publish = false

[changelog]
protect_breaking_commits = true
sort_commits = "oldest"

# Commit parsers: evaluated in order, first match wins.
# Skip rules come before mapping rules.
# See docs/COMMIT_GUIDELINE.md "CG: CHANGELOG Generation Guidelines" section.
commit_parsers = [
  # Skip: automated commits not relevant to release notes
  { message = "^chore: release", skip = true },
  { message = "^Merge", skip = true },
  { message = "^Revert \"", skip = true },
  { message = "^Initial plan", skip = true },
  # Map: commit types to Keep a Changelog sections
  { message = "^feat", group = "Added" },
  { message = "^fix", group = "Fixed" },
  { message = "^perf", group = "Performance" },
  { message = "^refactor", group = "Changed" },
  { message = "^docs", group = "Documentation" },
  { message = "^revert", group = "Reverted" },
  { message = "^deprecated", group = "Deprecated" },
  { message = "^security", group = "Security" },
  { message = "^chore", group = "Maintenance" },
  { message = "^ci", group = "Maintenance" },
  { message = "^build", group = "Maintenance" },
  { message = "^test", group = "Testing" },
  { message = "^style", group = "Styling" },
  # Catch-all
  { message = "^.*", group = "Other" },
]

# Convert GitHub issue/PR references to clickable links
commit_preprocessors = [
  { pattern = '#(\d+)', replace = "[#${1}](https://github.com/kent8192/reinhardt-web/issues/${1})" },
]
