# release-plz configuration for Reinhardt project
# Documentation: https://release-plz.ieni.dev/docs/config

[workspace]
# Changelog settings
changelog_update = true

# PR settings
# IMPORTANT: Branch prefix MUST start with "release-plz-" for native two-step release workflow.
# When release_always = false, release-plz checks if the latest commit is from a PR
# whose branch starts with "release-plz-" to determine if it should publish.
# See: https://release-plz.ieni.dev/docs/config#the-release_always-field
pr_branch_prefix = "release-plz-"
pr_labels = ["release", "automated"]
pr_name = "chore: release"

# Git release settings
git_release_enable = false
git_tag_enable = true
git_tag_name = "{{ package }}@v{{ version }}"
git_release_type = "auto"

# Publish settings
semver_check = false
publish_timeout = "10m"
dependencies_update = false

# Two-stage release workflow (native release-plz control):
# - Stage 1: Push to main → `release-plz release-pr` creates Release PR (branch: release-plz-*)
# - Stage 2: Merge Release PR → `release-plz release` detects commit from release-plz-* branch and publishes
#
# With release_always = false:
# - release-plz only publishes when the commit is from a merged release-plz-* branch PR
# - This gives maintainers control over when releases happen (must merge the Release PR)
# See: https://release-plz.ieni.dev/docs/config#the-release_always-field
release_always = false

# Skip cargo publish verification (dev-dependencies may reference unpublished workspace crates)
publish_no_verify = true

# CRITICAL: reinhardt-test publish ordering
# Many crates have reinhardt-test as dev-dependency. Due to Cargo 1.84+ regression
# (rust-lang/cargo#15151), cargo publish/package resolves ALL dependencies (including
# dev-dependencies) from crates.io during packaging, even with --no-verify.
# release-plz's topological sort doesn't account for dev-dependency edges, so we must
# pre-publish reinhardt-test in .github/workflows/release-plz.yml before the main
# release step runs. See the "Pre-publish reinhardt-test" step in the workflow.

# Main crate: only reinhardt-web gets GitHub Releases
[[package]]
name = "reinhardt-web"
git_release_enable = true

# Non-published packages (tests, examples, internal tools)
[[package]]
name = "reinhardt-test-support"
release = false
publish = false

[[package]]
name = "reinhardt-integration-tests"
release = false
publish = false

[[package]]
name = "reinhardt-benchmarks"
release = false
publish = false

[[package]]
name = "examples-hello-world"
release = false
publish = false

[[package]]
name = "examples-rest-api"
release = false
publish = false

[[package]]
name = "examples-database-integration"
release = false
publish = false

[[package]]
name = "examples-tutorial-basis"
release = false
publish = false

[[package]]
name = "examples-tutorial-rest"
release = false
publish = false

[[package]]
name = "examples-twitter"
release = false
publish = false

[[package]]
name = "examples-github-issues"
release = false
publish = false

[[package]]
name = "reinhardt-settings-cli"
release = false
publish = false

[changelog]
protect_breaking_commits = true
sort_commits = "oldest"

# Commit parsers: evaluated in order, first match wins.
# Skip rules come before mapping rules.
# See docs/COMMIT_GUIDELINE.md "CG: CHANGELOG Generation Guidelines" section.
commit_parsers = [
  # Skip: automated commits not relevant to release notes
  { message = "^chore: release", skip = true },
  { message = "^Merge", skip = true },
  { message = "^Revert \"", skip = true },
  { message = "^Initial plan", skip = true },
  # Map: commit types to Keep a Changelog sections
  { message = "^feat", group = "Added" },
  { message = "^fix", group = "Fixed" },
  { message = "^perf", group = "Performance" },
  { message = "^refactor", group = "Changed" },
  { message = "^docs", group = "Documentation" },
  { message = "^revert", group = "Reverted" },
  { message = "^deprecated", group = "Deprecated" },
  { message = "^security", group = "Security" },
  { message = "^chore", group = "Maintenance" },
  { message = "^ci", group = "Maintenance" },
  { message = "^build", group = "Maintenance" },
  { message = "^test", group = "Testing" },
  { message = "^style", group = "Styling" },
  # Catch-all
  { message = "^.*", group = "Other" },
]

# Convert GitHub issue/PR references to clickable links
commit_preprocessors = [
  { pattern = '#(\d+)', replace = "[#${1}](https://github.com/kent8192/reinhardt-web/issues/${1})" },
]
