# Makefile.toml for examples-database-integration
#
# This file provides cargo-make task definitions for common development operations.
# Install cargo-make: `cargo install cargo-make`
# Usage: `cargo make <task>`

[config]
default_to_workspace = false
skip_core_tasks = true

# ============================================================================
# Environment Variables
# ============================================================================

[env]
# Use local target directory for each example (independent from workspace)
CARGO_TARGET_DIR = { value = "target", condition = { env_not_set = ["CARGO_TARGET_DIR"] } }

# ============================================================================
# Development Server
# ============================================================================

[tasks.runserver]
description = "Start the development server"
command = "cargo"
args = ["run", "--bin", "examples-database-integration", "runserver"]

# ============================================================================
# Database Migrations
# ============================================================================

[tasks.makemigrations]
description = "Create new migrations based on model changes"
command = "cargo"
args = ["run", "--bin", "examples-database-integration", "makemigrations"]

[tasks.migrate]
description = "Apply database migrations"
command = "cargo"
args = ["run", "--bin", "examples-database-integration", "migrate"]

# ============================================================================
# Testing
# ============================================================================

[tasks.test]
description = "Run all tests"
command = "cargo"
args = ["nextest", "run", "--all-features"]

[tasks.test-unit]
description = "Run unit tests only"
command = "cargo"
args = ["nextest", "run", "--lib", "--all-features"]

[tasks.test-integration]
description = "Run integration tests only"
command = "cargo"
args = ["nextest", "run", "--test", "*", "--all-features"]

# ============================================================================
# Code Quality
# ============================================================================

[tasks.fmt-check]
description = "Check code formatting (rustfmt + page! DSL)"
command = "cargo"
args = ["run", "-p", "reinhardt-admin-cli", "--", "fmt", ".", "--check"]

[tasks.fmt-fix]
description = "Fix code formatting (rustfmt + page! DSL)"
command = "cargo"
args = ["run", "-p", "reinhardt-admin-cli", "--", "fmt", "."]

[tasks.clippy-check]
description = "Check linting rules"
command = "cargo"
args = ["clippy", "--all-features", "--", "-D", "warnings"]

[tasks.clippy-fix]
description = "Fix linting issues automatically"
command = "cargo"
args = ["clippy", "--all-features", "--fix", "--allow-dirty", "--allow-staged"]

[tasks.quality]
description = "Run all code quality checks (format + lint)"
dependencies = ["fmt-check", "clippy-check"]

[tasks.quality-fix]
description = "Fix all code quality issues automatically"
dependencies = ["fmt-fix", "clippy-fix"]

# ============================================================================
# Build & Clean
# ============================================================================

[tasks.build]
description = "Build the project in debug mode"
command = "cargo"
args = ["build", "--all-features"]

[tasks.build-release]
description = "Build the project in release mode"
command = "cargo"
args = ["build", "--release", "--all-features"]

[tasks.clean]
description = "Clean build artifacts"
command = "cargo"
args = ["clean"]

# ============================================================================
# CI/CD Workflow
# ============================================================================

[tasks.ci]
description = "Run CI pipeline (format, lint, build, test)"
dependencies = ["fmt-check", "clippy-check", "build", "test"]

# ============================================================================
# API Tests (Newman/Postman)
# ============================================================================

[tasks.api-test]
description = "Run Newman API tests"
script = '''
#!/bin/bash
docker-compose -f docker-compose.api-tests.yml up --build --abort-on-container-exit
docker-compose -f docker-compose.api-tests.yml down
'''

[tasks.api-test-report]
description = "Open API test report in browser"
script = '''
#!/bin/bash
open postman/reports/report.html
'''

[tasks.api-test-clean]
description = "Clean API test reports"
script = '''
#!/bin/bash
rm -f postman/reports/*.xml postman/reports/*.html
'''

# ============================================================================
# Help
# ============================================================================

[tasks.help]
description = "Show available tasks"
script = '''
echo "Available tasks:"
echo "  Development:"
echo "    runserver          - Start the development server"
echo ""
echo "  Database:"
echo "    makemigrations     - Create new migrations"
echo "    migrate            - Apply migrations"
echo ""
echo "  Testing:"
echo "    test               - Run all tests"
echo "    test-unit          - Run unit tests"
echo "    test-integration   - Run integration tests"
echo ""
echo "  Code Quality:"
echo "    fmt-check          - Check formatting (rustfmt + page! DSL)"
echo "    fmt-fix            - Fix formatting (rustfmt + page! DSL)"
echo "    clippy-check       - Check linting"
echo "    clippy-fix         - Fix linting issues"
echo "    quality            - Run all checks"
echo "    quality-fix        - Fix all issues"
echo ""
echo "  Build:"
echo "    build              - Build (debug)"
echo "    build-release      - Build (release)"
echo "    clean              - Clean artifacts"
echo ""
echo "  CI/CD:"
echo "    ci                 - Run CI pipeline"
echo ""
echo "Usage: cargo make <task>"
'''
