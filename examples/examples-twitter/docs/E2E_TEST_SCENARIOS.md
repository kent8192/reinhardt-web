# E2Eテストシナリオ

## 概要
このドキュメントはTwitterクローンアプリケーションのエンドツーエンドテストシナリオを定義します。WASMフロントエンドとバックエンドサーバーの統合テストを対象とし、実際のユーザーフローをシミュレートします。

## テスト環境要件
- **フロントエンド**: WASMアプリケーション (`dist-wasm/` ビルド出力)
- **バックエンド**: 開発サーバー (ポート8000)
- **データベース**: SQLite (テスト用マイグレーション適用済み)
- **テストフレームワーク**: Playwright
- **ブラウザ**: Chromium (ヘッドレスモード推奨)

## テストデータ設定
各テストの前提条件として以下のテストデータが必要です：

```typescript
// テストユーザー
const TEST_USERS = {
  existing: {
    username: 'testuser',
    email: 'test@example.com',
    password: 'Password123!'
  },
  new: {
    username: 'newuser',
    email: 'new@example.com',
    password: 'NewPassword123!'
  }
};

// テストツイート
const TEST_TWEETS = {
  simple: 'これはテストツイートです。',
  long: 'x'.repeat(280), // 最大長
  withHashtag: '#テスト #Twitterクローン'
};
```

## シナリオ1: 新規ユーザー登録フロー
### 概要
新規ユーザーがアプリケーションに登録し、タイムラインページにリダイレクトされるまでのフローを検証します。

### 前提条件
- アプリケーションが `/` でアクセス可能
- テストユーザーのメールアドレスが未登録
- サーバーが正常に動作している

### テストステップ
1. **ホームページ表示** → 「ログイン」と「登録」リンクが表示される
2. **登録ページ遷移** → 登録フォームが表示される（ユーザー名、メール、パスワード、確認用パスワードフィールド）
3. **有効な情報入力** → すべてのフィールドに有効な値を入力
4. **フォーム送信** → 成功メッセージ表示、`/login` ページへリダイレクト
5. **ログインページ確認** → 登録成功メッセージとログインフォームが表示される

### 検証ポイント
- [ ] 登録フォームの必須フィールドが適切にバリデーションされる
- [ ] パスワード不一致時にエラーメッセージが表示される
- [ ] 重複メールアドレスで適切なエラーメッセージが表示される
- [ ] 登録成功後、ログインページにリダイレクトされる
- [ ] ログインページで登録成功メッセージが表示される

### エッジケース
- パスワード強度不足（短すぎる、複雑さ不足）
- 無効なメールアドレス形式
- ユーザー名に無効な文字を含む
- ネットワークエラー発生時の挙動

## シナリオ2: 既存ユーザーログインフロー
### 概要
既存ユーザーがログインし、タイムラインページにアクセスするフローを検証します。

### 前提条件
- テストユーザーが既に登録済み
- ユーザーがログアウト状態

### テストステップ
1. **ログインページ表示** → ログインフォームが表示される
2. **有効な認証情報入力** → 登録済みのメールアドレスとパスワードを入力
3. **フォーム送信** → 成功メッセージ表示、`/timeline` ページへリダイレクト
4. **タイムラインページ確認** → ユーザー名表示、ツイート作成フォームが表示される
5. **認証状態の永続性** → ページリロード後もログイン状態が維持される

### 検証ポイント
- [ ] 無効な認証情報で適切なエラーメッセージが表示される
- [ ] ログイン成功後、タイムラインページにリダイレクトされる
- [ ] タイムラインページでユーザー名が正しく表示される
- [ ] セッションが適切に維持される
- [ ] ログアウトリンクが表示される

### エッジケース
- 無効なメールアドレス形式
- 間違ったパスワード
- 存在しないユーザーでのログイン試行
- アカウントが無効化されている場合

## シナリオ3: ツイート作成フロー
### 概要
ログイン済みユーザーが新しいツイートを作成するフローを検証します。

### 前提条件
- ユーザーがログイン済み
- タイムラインページ (`/timeline`) にアクセス可能

### テストステップ
1. **タイムラインページ表示** → ツイート作成フォームが表示される
2. **ツイート内容入力** → 有効なツイート内容を入力（1〜280文字）
3. **文字数カウンター確認** → 入力に応じて文字数が更新される
4. **ツイート投稿** → 投稿ボタンをクリック
5. **投稿成功確認** → ツイートがタイムラインに表示される
6. **ページリロード** → 投稿したツイートが永続化されている

### 検証ポイント
- [ ] 空のツイートは投稿できない
- [ ] 280文字を超えるツイートは投稿できない
- [ ] 文字数カウンターが正しく動作する（通常/警告/危険状態）
- [ ] 投稿成功後、フォームがクリアされる
- [ ] 投稿したツイートがタイムラインの先頭に表示される
- [ ] ツイートに作成日時が正しく表示される

### エッジケース
- ちょうど280文字のツイート
- 特殊文字（絵文字、改行、ハッシュタグ）を含むツイート
- ネットワークエラー発生時のリトライ挙動
- 連続投稿の制限

## シナリオ4: ツイート削除フロー
### 概要
ユーザーが自身のツイートを削除するフローを検証します。

### 前提条件
- ユーザーがログイン済み
- ユーザーが少なくとも1つのツイートを投稿済み
- タイムラインページにツイートが表示されている

### テストステップ
1. **タイムラインページ表示** → ユーザーのツイートに削除ボタンが表示される
2. **削除ボタンクリック** → 削除確認ダイアログが表示される（必要な場合）
3. **削除確認** → 削除を実行
4. **削除成功確認** → ツイートがタイムラインから消える
5. **ページリロード** → 削除されたツイートが再表示されない

### 検証ポイント
- [ ] 自分のツイートにのみ削除ボタンが表示される
- [ ] 削除後、ツイートが即座に非表示になる
- [ ] 削除後にページリロードしてもツイートが表示されない
- [ ] 削除失敗時（権限不足など）に適切なエラーメッセージが表示される

### エッジケース
- 他のユーザーのツイートを削除しようとした場合
- 削除中のネットワーク切断
- 同時削除の競合状態

## シナリオ5: プロフィール表示フロー
### 概要
ユーザーが自身または他のユーザーのプロフィールを表示するフローを検証します。

### 前提条件
- ユーザーがログイン済み
- 表示対象のユーザーが存在する
- プロフィール情報（bio、場所、ウェブサイト）が設定されている

### テストステップ
1. **プロフィールページ遷移** → `profile/{user_id}` にアクセス
2. **プロフィール情報確認** → ユーザー名、アバター、bio、場所、ウェブサイトが表示される
3. **フォロー情報確認** → フォロー数、フォロワー数が表示される
4. **ツイートリスト確認** → ユーザーのツイート一覧が表示される
5. **アクション確認** → フォローボタン、プロフィール編集ボタンが適切に表示される

### 検証ポイント
- [ ] 存在しないユーザーIDで404エラーが表示される
- [ ] 自分のプロフィールには編集ボタンが表示される
- [ ] 他のユーザーのプロフィールにはフォローボタンが表示される
- [ ] プロフィール情報が正しく表示される
- [ ] ユーザーのツイートが正しくフィルタリングされて表示される

## シナリオ6: プロフィール編集フロー
### 概要
ユーザーが自身のプロフィール情報を編集するフローを検証します。

### 前提条件
- ユーザーがログイン済み
- プロフィール編集ページ (`/profile/{user_id}/edit`) にアクセス可能

### テストステップ
1. **プロフィール編集ページ遷移** → 編集フォームが表示される
2. **現在の値確認** → フォームに現在のプロフィール情報が表示される
3. **情報更新** → 各フィールドを更新
4. **フォーム送信** → 保存ボタンをクリック
5. **成功確認** → 成功メッセージ表示、プロフィールページへリダイレクト
6. **変更反映確認** → 更新した情報がプロフィールページに反映されている

### 検証ポイント
- [ ] フォームに現在のプロフィール情報が正しく表示される
- [ ] バリデーションエラーが適切に表示される（無効なURLなど）
- [ ] 保存成功後、プロフィールページにリダイレクトされる
- [ ] 更新した情報が正しく反映される
- [ ] キャンセルボタンでプロフィールページに戻る

## シナリオ7: フォロー/アンフォローフロー
### 概要
ユーザーが他のユーザーをフォロー/アンフォローするフローを検証します。

### 前提条件
- ユーザーA（ログイン済み）とユーザーB（存在するユーザー）が存在
- ユーザーAはユーザーBをまだフォローしていない

### テストステップ
1. **ユーザーBのプロフィール表示** → フォローボタンが「Follow」と表示される
2. **フォロー実行** → フォローボタンをクリック
3. **状態更新確認** → ボタンが「Following」に変わる
4. **フォロワー数更新** → ユーザーBのフォロワー数が増加
5. **アンフォロー実行** → 「Following」ボタンをクリック
6. **状態戻り確認** → ボタンが「Follow」に戻る
7. **フォロワー数減少確認** → ユーザーBのフォロワー数が減少

### 検証ポイント
- [ ] フォロー状態に応じてボタンテキストが正しく変わる
- [ ] フォローボタンホバー時に「Unfollow」が表示される
- [ ] フォロー/アンフォロー後にカウントが即座に更新される
- [ ] ネットワークエラー時も状態がロールバックされる
- [ ] 自分自身をフォローできない

## シナリオ8: ナビゲーションフロー
### 概要
アプリケーション内のページ遷移フローを検証します。

### 前提条件
- アプリケーションが正常に動作している
- ユーザーがログイン済み

### テストステップ
1. **ホームページからログインページ** → ログインリンクをクリック
2. **ログインページから登録ページ** → 登録リンクをクリック
3. **登録ページからログインページ** → ログインリンクをクリック
4. **ログイン後タイムラインページ** → ログイン成功後自動遷移
5. **タイムラインページからプロフィール** → ユーザー名リンクをクリック
6. **プロフィールから編集ページ** → 編集ボタンをクリック
7. **編集ページからプロフィール** → キャンセルボタンをクリック
8. **ブラウザ戻る/進む** → 履歴ナビゲーションが正しく動作

### 検証ポイント
- [ ] すべてのナビゲーションリンクが正しく動作する
- [ ] 認証が必要なページは未認証時にリダイレクトされる
- [ ] ブラウザの戻る/進むボタンが正しく動作する
- [ ] 現在のページがナビゲーションで正しくハイライトされる
- [ ] 404ページが存在しないルートで表示される

## シナリオ9: エラーハンドリングフロー
### 概要
アプリケーションのエラーハンドリング機能を検証します。

### 前提条件
- アプリケーションが正常に動作している

### テストステップ
1. **ネットワークエラーシミュレーション** → サーバーに接続できない状態で操作
2. **無効なフォーム入力** → バリデーションエラーをトリガー
3. **権限エラー** → 権限のない操作を実行
4. **サーバーエラー** → サーバー側で500エラーを発生
5. **クライアントエラー** → JavaScriptエラーを発生

### 検証ポイント
- [ ] ネットワークエラー時、適切なエラーメッセージが表示される
- [ ] フォームバリデーションエラーがフィールド近くに表示される
- [ ] 権限エラー時、適切なメッセージと代替アクションが提供される
- [ ] サーバーエラー時、ユーザーフレンドリーなメッセージが表示される
- [ ] エラー後もアプリケーションがクラッシュせずに動作する

## シナリオ10: レスポンシブデザインフロー
### 概要
異なる画面サイズでのレイアウトと機能を検証します。

### 前提条件
- アプリケーションが正常に動作している
- ユーザーがログイン済み

### テストステップ
1. **デスクトップ表示** → 幅1200px以上で表示確認
2. **タブレット表示** → 幅768pxで表示確認
3. **モバイル表示** → 幅375pxで表示確認
4. **画面回転** → 縦向き/横向きでの表示確認
5. **ズーム操作** → ブラウザズーム機能での表示確認

### 検証ポイント
- [ ] すべての画面幅でレイアウトが崩れない
- [ ] モバイルでナビゲーションメニューが適切に折りたたまれる
- [ ] フォーム要素がタッチ操作に適切なサイズである
- [ ] 画像とメディアが画面幅に応じて適切にスケーリングされる
- [ ] テキストが読めるサイズで表示される

## テスト実装ガイドライン

### Playwright設定
```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:8000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'mobile-chrome',
      use: { ...devices['Pixel 5'] },
    },
  ],
  webServer: {
    command: 'cargo run --bin runserver',
    url: 'http://localhost:8000',
    reuseExistingServer: !process.env.CI,
    timeout: 120 * 1000, // 2分
  },
});
```

### ページオブジェクトパターン
```typescript
// tests/pages/login-page.ts
export class LoginPage {
  constructor(private page: Page) {}

  async navigate() {
    await this.page.goto('/login');
  }

  async login(email: string, password: string) {
    await this.page.fill('input[name="email"]', email);
    await this.page.fill('input[name="password"]', password);
    await this.page.click('button[type="submit"]');
  }

  async getErrorMessage() {
    return this.page.textContent('.alert-danger');
  }

  async isRedirectedToTimeline() {
    return this.page.url().includes('/timeline');
  }
}
```

### テストデータ管理
```typescript
// tests/fixtures/test-data.ts
export interface TestUser {
  username: string;
  email: string;
  password: string;
}

export const createTestUser = async (): Promise<TestUser> => {
  // テストユーザーを作成するヘルパー関数
  // データベースに直接挿入またはAPI経由で作成
};

export const cleanupTestData = async (): Promise<void> => {
  // テストデータをクリーンアップする関数
};
```

## 優先順位と実行計画

### 高優先度（MVP機能）
1. シナリオ1: 新規ユーザー登録フロー
2. シナリオ2: 既存ユーザーログインフロー
3. シナリオ3: ツイート作成フロー
4. シナリオ8: ナビゲーションフロー

### 中優先度（主要機能）
5. シナリオ4: ツイート削除フロー
6. シナリオ5: プロフィール表示フロー
7. シナリオ6: プロフィール編集フロー
8. シナリオ7: フォロー/アンフォローフロー

### 低優先度（拡張機能）
9. シナリオ9: エラーハンドリングフロー
10. シナリオ10: レスポンシブデザインフロー

## 成功基準
- すべての高優先度シナリオがパスする
- テストカバレッジが主要ユーザーフローの80%以上をカバー
- テスト実行時間が10分以内
- フラッキーテストが5%未満

---

*最終更新日: 2026-01-09*  
*シナリオバージョン: 1.0.0*