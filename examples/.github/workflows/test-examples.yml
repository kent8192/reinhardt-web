name: Test Examples

on:
  push:
    branches: [main]
  pull_request:
  schedule:
    - cron: '0 9 * * *'  # 09:00 UTC daily

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  test-local-examples:
    name: Test ${{ matrix.example }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        example:
          - examples-hello-world
          - examples-rest-api
          - examples-database-integration
          - examples-tutorial-basis
          - examples-tutorial-rest
          - examples-github-issues
          - examples-twitter

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@1.91.1
        with:
          components: rustfmt, clippy

      - name: Cache Cargo Registry
        uses: actions/cache@v5
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Cargo Git
        uses: actions/cache@v5
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Target
        uses: actions/cache@v5
        with:
          path: target
          key: ${{ runner.os }}-target-${{ matrix.example }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: Check Format
        working-directory: local/${{ matrix.example }}
        run: cargo fmt --check

      - name: Clippy
        working-directory: local/${{ matrix.example }}
        run: cargo clippy --all-features -- -D warnings

      - name: Build
        working-directory: local/${{ matrix.example }}
        run: cargo build --all-features

      - name: Test
        working-directory: local/${{ matrix.example }}
        run: cargo nextest run --all-features

      - name: Doc Test
        working-directory: local/${{ matrix.example }}
        run: cargo test --doc --all-features

  test-common-crates:
    name: Test Common Crates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@1.91.1

      - name: Test common
        working-directory: remote/common
        run: cargo test --all-features

      - name: Test test-macros
        working-directory: remote/test-macros
        run: cargo test --all-features

  compatibility-report:
    name: Compatibility Report
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    needs: [test-local-examples, test-common-crates]
    steps:
      - name: Report Success
        run: echo "âœ… All examples compatible"

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Daily Compatibility Check Failed',
              body: `Daily compatibility check failed. Please investigate.\n\nWorkflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
              labels: ['compatibility', 'bug']
            })
