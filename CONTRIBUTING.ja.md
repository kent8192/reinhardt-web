# Reinhardt への貢献

Reinhardt プロジェクトへの貢献に興味を持っていただき、ありがとうございます！このドキュメントでは、プロジェクトに貢献するためのガイドラインとベストプラクティスを提供します。

## 目次

- [はじめに](#はじめに)
- [開発環境のセットアップ](#開発環境のセットアップ)
- [コードスタイルと規約](#コードスタイルと規約)
- [テストガイドライン](#テストガイドライン)
- [コミットガイドライン](#コミットガイドライン)
- [プルリクエストプロセス](#プルリクエストプロセス)
- [ドキュメント](#ドキュメント)
- [サポート](#サポート)

---

## はじめに

### 前提条件

- Rust 1.75+ (2024 Edition)
- PostgreSQL (データベース関連のテスト用)
- Docker (オプション、TestContainers 用)

### フォークとクローン

1. GitHub でリポジトリをフォーク
2. ローカルにフォークをクローン：
   ```bash
   git clone https://github.com/YOUR_USERNAME/reinhardt.git
   cd reinhardt
   ```
3. アップストリームリポジトリを追加：
   ```bash
   git remote add upstream https://github.com/ORIGINAL_OWNER/reinhardt.git
   ```

### プロジェクトのビルド

```bash
# ワークスペース全体をビルド
cargo build --workspace

# 特定のクレートをビルド
cargo build --package reinhardt-orm

# すべての機能を有効にしてビルド
cargo build --workspace --all-features
```

### テストの実行

```bash
# すべてのテストを実行
cargo test --workspace

# 特定のクレートのテストを実行
cargo test --package reinhardt-orm

# 統合テストを実行
cargo test --package reinhardt-integration-tests
```

---

## 開発環境のセットアップ

### プロジェクト構造

Reinhardt はワークスペース構造を使用しています：

- **機能クレート**: `crates/reinhardt-*/` - 個々の機能実装
- **テストクレート**: `tests/` - 統合テストのみ
- **各クレート**: `tests/` またはインラインに独自のユニットテストを含む

### モジュールシステム

**重要**: Reinhardt は Rust 2024 Edition モジュールシステムを使用します：

- ❌ **使用禁止**: `mod.rs` ファイル
- ✅ **使用推奨**: `module_name.rs` ファイル
- ✅ **宣言方法**: `lib.rs` または親モジュールで `mod module_name;` を使用

例：

```rust
// lib.rs 内
pub mod http;
pub mod routing;

// ファイル構造:
// src/
//   lib.rs
//   http.rs          // ✅ 正しい
//   routing.rs       // ✅ 正しい
//   http/mod.rs      // ❌ 使用禁止
```

---

## コードスタイルと規約

### 一般的なガイドライン

1. **Rust の命名規則に従う**：
   - `snake_case`: 関数、変数、モジュール
   - `PascalCase`: 型、トレイト、列挙型
   - `SCREAMING_SNAKE_CASE`: 定数

2. **コードの整理**：
   - 関連する機能をまとめる
   - 関心事の明確な分離を維持
   - インポートを論理的にグループ化（std、外部クレート、内部クレート）

3. **文字列変換**：
   - `.to_string()` 呼び出しを**最小限に**
   - 可能な限り借用と文字列スライスを優先
   - 適切な場合は `String::from()`、`format!()`、または `Cow<str>` を使用

### コードのクリーンアップ

- **古いコードは即座に削除** - コメントアウトされたコードを残さない
- **削除されたコードを記録するコメントは禁止** - Git 履歴が記録
- 重要な注記が必要な場合は `docs/IMPLEMENTATION_NOTES.md` に抽出

### TODO とプレースホルダーポリシー

**TODO コメント**：

- `// TODO:` を計画および未実装機能に使用
- 実装が必要な内容と保留理由を説明
- 機能実装時に**削除**

**ランタイムマーカー**：

- `todo!()`: **実装予定**の機能に使用
- `unimplemented!()`: **実装しない**機能（意図的に省略）に使用

**プレースホルダー実装**：

- **すべて**のプレースホルダー実装は `todo!()` または `// TODO:` でマークする**必須**
- 対象：
  - デフォルト値を返す空の関数本体
  - 最小限のロジックのスタブ実装
  - 後で置き換える予定のモック実装
- **例外**: テストとドキュメントは簡略化された実装を使用可能

例：

```rust
// ✅ 良い: マークされたプレースホルダー
pub fn get_cache_config() -> CacheConfig {
    todo!("設定からキャッシュ設定を読み込む実装")
}

// ✅ 良い: TODO コメントを使用
pub fn validate_input(data: &str) -> Result<()> {
    // TODO: 入力検証ロジックを追加 - 次のスプリントで計画
    Ok(())
}

// ✅ 良い: 意図的に実装しない
fn legacy_api() -> String {
    unimplemented!("このレガシー API は意図的にサポートされていません")
}

// ❌ 悪い: マークされていないプレースホルダー
pub fn get_config() -> Config {
    Config::default()  // 本番環境対応に見える！
}
```

### パス参照

- **使用禁止**: 2レベル以上上がる相対パス（例: `../..`）
- **推奨**: 絶対パスまたは1レベルの相対パス（例: `../`）
- 深い相対パスはコードを理解しにくくする

---

## テストガイドライン

### テストの哲学

1. **スケルトン実装禁止**: テストには意味のあるアサーションが**必須**
   - コードが間違っている場合に失敗できるテストが必要
   - ❌ 悪い: `assert!(true)` または空のテスト本体
   - ✅ 良い: 実際のアサーションを持つテスト

2. **Reinhardt コンポーネントの使用**: すべてのテストは少なくとも1つの Reinhardt クレートコンポーネントを使用する**必須**

3. **ドキュメントテスト**: すべての機能のドキュメントテストを実装
   - ドキュメントテストをユニット/統合テストとして重複させない

### テストの構成

**ユニットテスト**：

- 正確に**1つ**の Reinhardt クレートを使用
- テスト対象の機能クレート内に配置
- そのクレートの機能を単独でテスト

**統合テスト**：

- **2つ以上**の Reinhardt クレートを使用
- `tests` クレートに配置する**必須**
- 複数のクレート間の相互作用をテスト

**依存関係ルール**：

- 機能クレートは他の Reinhardt クレートを `dev-dependencies` に含めては**いけません**
- これによりユニットテストが独立した状態を維持

### テストの実装

**グローバル状態管理**：

- グローバル状態を変更するテストは `serial_test` クレートを使用してシリアル化する**必須**
- 名前付きシリアルグループを使用: `#[serial(group_name)]`
- 一般的なグループ: `i18n`、`url_overrides` など
- 必ずクリーンアップ関数を teardown で呼び出す

例：

```rust
use serial_test::serial;

#[test]
#[serial(i18n)]
fn test_translation() {
    activate("fr", catalog);
    // テストコード
    deactivate(); // クリーンアップ
}
```

**テストクリーンアップ**：

- テスト中に作成された**すべて**のファイル、ディレクトリ、環境変更は完了時に削除する**必須**
- テストフィクスチャ、`Drop` 実装、または明示的なクリーンアップを使用

**インフラストラクチャテスト**：

- 実際のインフラストラクチャ（データベース、メッセージキューなど）が必要なテストには **TestContainers** を使用
- 可能な場合はモックよりも実際のインフラストラクチャを優先

---

## コミットガイドライン

### コミットポリシー

**重要なルール**：

- 明示的なユーザー指示なしにコミットを作成**しない**
- 明示的なユーザー指示なしにコミットをプッシュ**しない**
- コミット前に必ずユーザーの確認を待つ

### コミットの粒度

- 各コミットは**単一の論理的な変更**を表す必要がある
- **各コミットは1行で説明できるほど小さくする必須**
  - 1行で明確に説明できない場合、大きすぎるので分割する
  - 大きな変更は複数のコミットに分割
- 変更目的ごとに細かいレベルでファイルをグループ化

### 部分的ファイルコミット

ファイルに異なる目的の変更が含まれる場合、以下を使用：

**方法1: エディタベースのパッチ編集（推奨）**

```bash
git add -e <file>
```

**方法2: パッチファイルアプローチ**

```bash
git diff <file> > /tmp/changes.patch
# パッチファイルを編集
git apply --cached /tmp/changes.patch
```

### コミットメッセージフォーマット

**構造**：

```
type(scope): 英語での簡潔な説明

変更の詳細を説明する本文。

モジュールセクション:
- file/path.rs: +XXX 行 - 説明
  - サブ詳細 1
  - サブ詳細 2
- 削除: old_file.rs (理由)

機能:
- 機能 1
- 機能 2

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

**Type 値**：

- `feat`: 新機能
- `fix`: バグ修正
- `refactor`: コードのリファクタリング
- `test`: テストの変更
- `docs`: ドキュメントの変更
- `chore`: ビルド/ツールの変更
- `perf`: パフォーマンス改善
- `style`: コードスタイルの変更

**Scope**: モジュールまたはコンポーネント名（例: `orm`、`http`、`shortcuts`）

**要件**：

- 件名行: 具体的に、曖昧にしない
- 本文: モジュール/コンポーネントごとに整理、行数変更を含むファイル変更をリスト
- フッター: Claude Code の帰属と Co-Authored-By 行を含める
- 本文とフッターの間に正確に1行の空行

**スタイル参照**：
新しいコミットを書く前に、常に最近のコミットを確認：

```bash
git log --pretty=format:"%s%n%b" -10
```

詳細なコミットガイドラインについては、[CLAUDE.commit.md](CLAUDE.commit.md) を参照してください。

---

## プルリクエストプロセス

### 提出前

1. **すべてのテストが通ることを確認**：

   ```bash
   cargo test --workspace
   ```

2. **コードフォーマットを実行**：

   ```bash
   cargo fmt --all
   ```

3. **リントの問題を確認**：

   ```bash
   cargo clippy --workspace -- -D warnings
   ```

4. **ドキュメントを更新**（[ドキュメント](#ドキュメント)セクションを参照）

### プルリクエストの提出

1. **機能ブランチを作成**：

   ```bash
   git checkout -b feature/your-feature-name
   ```

2. **変更を行う**（このドキュメントのガイドラインに従う）

3. **変更をコミット**（コミットガイドラインに従う）

4. **フォークにプッシュ**：

   ```bash
   git push origin feature/your-feature-name
   ```

5. **GitHub でプルリクエストを開く**：
   - 変更を説明する明確なタイトル
   - 何を、なぜ変更したかを説明する説明文
   - 関連する issue への参照

### PR レビュープロセス

- メンテナーが PR をレビュー
- フィードバックと要求された変更に対応
- 承認後、メンテナーが PR をマージ

---

## ドキュメント

### 更新要件

機能の実装または変更時には**常に**ドキュメントを更新：

- **README.md**: プロジェクトレベルの概要
- **クレート README.md**: 個別クレートのドキュメント
- **docs/** ディレクトリ: 詳細なガイドとチュートリアル

### ドキュメントの一貫性

- すべてのドキュメントレベルで一貫性を確保

### ドキュメントの範囲

以下の場合にドキュメントを更新：

- **新機能**: 説明、使用例、API リファレンスを追加
- **変更された機能**: 影響を受けるセクションを更新
- **非推奨の機能**: 非推奨としてマーク、移行ガイドを提供
- **削除された機能**: ドキュメントを削除、必要に応じて移行ノートを追加

### ドキュメントの品質

- ドキュメント内の例がテスト済みで動作することを確認
- コードスニペットを現在の API に反映するよう更新
- すべてのリンクと参照が有効であることを確認
- 用語とフォーマットの一貫性を維持

---

## サポート

### リソース

- 📖 [スタートガイド](docs/GETTING_STARTED.md)
- 📖 [機能フラグガイド](docs/FEATURE_FLAGS.md)
- 📖 [プロジェクト指示](CLAUDE.md)
- 💬 GitHub Discussions（質問とアイデア用）
- 🐛 GitHub Issues（バグレポート用）

### 質問前の確認事項

以下を確認してください：

- ✅ [スタートガイド](docs/GETTING_STARTED.md)
- ✅ [サンプル](examples/)
- ✅ 既存の GitHub Issues と Discussions
- ✅ プロジェクト固有のガイドラインについては [CLAUDE.md](CLAUDE.md)

---

## クイックリファレンス

### 重要なルール

**コードとモジュールシステム**：

- ❌ `mod.rs` ファイル禁止
- ❌ ユーザー向けプレースホルダーでの TODO/NOTE コメント禁止
- ❌ マークされていないプレースホルダー実装禁止
- ✅ 2024 edition モジュールシステムを使用
- ✅ すべてのプレースホルダーを `todo!()` または `// TODO:` でマーク

**テスト**：

- ❌ スケルトンテスト禁止
- ❌ 機能クレートでのクレート間 dev-dependencies 禁止
- ✅ すべてのテスト成果物をクリーンアップ
- ✅ `#[serial]` を使用してグローバル状態を持つテストをシリアル化

**ファイル管理**：

- ❌ プロジェクトディレクトリへのファイル保存禁止（`/tmp` を使用）
- ❌ 2レベル以上の相対パス禁止
- ✅ 完了時に `/tmp` ファイルを削除

**ドキュメント**：

- ❌ コード変更後の古いドキュメント禁止
- ✅ コード変更と同時にドキュメントを更新

**コミット**：

- ❌ ユーザー指示なしのコミット禁止
- ❌ 確認なしのバッチコミット禁止
- ✅ 論理的な目的ごとにコミットを分割
- ✅ コミットを小さく焦点を絞って保つ

---

## ライセンス

Reinhardt への貢献により、あなたの貢献が MIT ライセンスと Apache License 2.0 の両方の下でライセンスされることに同意したものとみなされます。

---

Reinhardt への貢献、ありがとうございます！ 🦀