# Reinhardt - cargo-make configuration

[config]
default_to_workspace = false

# Environment variables
[env]
CARGO_TERM_COLOR = "always"
RUST_BACKTRACE = "1"

# ============================================================================
# Core Development Tasks
# ============================================================================

[tasks.check]
description = "Run cargo check on workspace"
command = "cargo"
args = [
  "check",
  "--workspace",
  "--all",
  "--all-features",
  "--all-targets",
  "--tests",
  "--benches",
  "--examples",
  "--quiet"
]

[tasks.build]
description = "Build workspace"
command = "cargo"
args = ["build", "--workspace", "--all", "--all-features", "--all-targets", "--quiet", "--bins", "--examples", "--tests", "--benches"]

[tasks.build-release]
description = "Build workspace in release mode"
command = "cargo"
args = ["build", "--workspace", "--all", "--all-features", "--release", "--quiet"]

[tasks.clean]
description = "Clean build artifacts"
command = "cargo"
args = ["clean"]

# ============================================================================
# Code Quality Tasks
# ============================================================================

[tasks.fmt-check]
description = "Check code formatting (CI mode)"
command = "cargo"
args = ["fmt", "--check", "--all"]

[tasks.fmt-fix]
description = "Auto-fix code formatting"
command = "cargo"
args = ["fmt", "--all"]

[tasks.clippy-check]
description = "Run clippy linter"
command = "cargo"
args = [
  "clippy",
  "--workspace",
  "--all",
  "--all-features",
  "--",
  "-D",
  "warnings",
]

[tasks.clippy-fix]
description = "Run clippy linter and automatically fix found errors."
command = "cargo"
args = [
  "clippy",
  "--fix",
  "--workspace",
  "--all",
  "--all-features",
  "--allow-dirty",
  "--",
  "-D",
  "warnings",
]

[tasks.fmt-page]
description = "Format page! macro DSL in source files"
command = "cargo"
args = ["run", "-p", "reinhardt-admin-cli", "--", "fmt", "."]

[tasks.fmt-page-check]
description = "Check page! macro DSL formatting (CI mode)"
command = "cargo"
args = ["run", "-p", "reinhardt-admin-cli", "--", "fmt", "--check", "."]

[tasks.auto-fix]
description = "Run all auto-fixes"
dependencies = ["clippy-fix", "fmt-fix", "fmt-page"]

# ============================================================================
# Testing Tasks
# ============================================================================

[tasks.doc-test]
description = "Run only documentation tests"
command = "cargo"
args = ["test", "--workspace", "--doc", "--quiet", "--all-features", "--no-fail-fast"]

[tasks.doc-test-crate]
description = "Run documentation tests for specific package(s). Usage: cargo make doc-test-crate -- -p package1 -p package2"
script = '''
#!/bin/bash
args="${CARGO_MAKE_TASK_ARGS#--}"
args="${args//;/ }"
cargo test $args --doc --quiet --all-features --no-fail-fast
'''

[tasks.bench]
description = "Run benchmark tests in tests/bench"
command = "cargo"
args = ["bench", "--manifest-path", "tests/bench/Cargo.toml"]

[tasks.unit-test]
description = "Run unit tests (src/)"
command = "cargo"
args = [
  "nextest",
  "run",
  "--workspace",
  "--lib",
  "--exclude",
  "reinhardt-integration-tests",
  "--all-features",
  "--no-fail-fast",
  "--show-progress=none",
  "--status-level=none",
  "--final-status-level=none",
]

[tasks.unit-test-crate]
description = "Run unit tests for specific package(s). Usage: cargo make unit-test-crate -- -p package1 -p package2"
script = '''
#!/bin/bash
args="${CARGO_MAKE_TASK_ARGS#--}"
args="${args//;/ }"
cargo nextest run $args --lib --all-features --no-fail-fast --show-progress=none --status-level=none --final-status-level=none
'''

[tasks.intra-crate-integration-test]
description = "Run intra-crate integration tests (tests/)"
command = "cargo"
args = [
  "nextest",
  "run",
  "--workspace",
  "--test",
  "*",
  "--exclude",
  "reinhardt-integration-tests",
  "--all-features",
  "--no-fail-fast",
  "--show-progress=none",
  "--status-level=none",
  "--final-status-level=none"
]

[tasks.intra-crate-integration-test-crate]
description = "Run intra-crate integration tests for specific package(s). Usage: cargo make intra-crate-integration-test-crate -- -p package1 -p package2"
script = '''
#!/bin/bash
args="${CARGO_MAKE_TASK_ARGS#--}"
args="${args//;/ }"
cargo nextest run $args --test "*" --all-features --no-fail-fast --show-progress=none --status-level=none --final-status-level=none
'''

[tasks.cross-crate-integration-test]
description = "Run cross-crate integration tests (reinhardt-integration-tests)"
command = "cargo"
args = [
  "nextest",
  "run",
  "--package",
  "reinhardt-integration-tests",
  "--all-features",
  "--no-fail-fast",
  "--show-progress=none",
  "--status-level=none",
  "--final-status-level=none"
]

[tasks.integration-test]
description = "Run all integration tests"
dependencies = ["intra-crate-integration-test", "cross-crate-integration-test"]

[tasks.local-examples-test]
description = "Test local examples (now part of workspace)"
command = "cargo"
args = [
  "nextest",
  "run",
  "-p", "examples-hello-world",
  "-p", "examples-rest-api",
  "-p", "examples-database-integration",
  "-p", "examples-tutorial-basis",
  "-p", "examples-tutorial-rest",
  "-p", "examples-twitter",
  "-p", "examples-github-issues",
  "--verbose"
]

[tasks.local-examples-test-crate]
description = "Test specific local example(s). Usage: cargo make local-examples-test-crate -- -p examples-hello-world -p examples-rest-api"
script = '''
#!/bin/bash
args="${CARGO_MAKE_TASK_ARGS#--}"
args="${args//;/ }"
cargo nextest run $args --verbose
'''

[tasks.remote-examples-test]
description = "Test remote examples (uses crates.io published versions)"
cwd = "examples/remote"
command = "cargo"
args = ["nextest", "run", "--workspace", "--verbose"]

[tasks.examples-test]
description = "Test all examples (local + remote)"
dependencies = ["local-examples-test", "remote-examples-test"]

[tasks.test]
description = "Run all tests"
dependencies = [
  "unit-test",
  "integration-test",
  "doc-test",
  "examples-test",
]

# ============================================================================
# CI Tasks
# ============================================================================

[tasks.ci]
description = "Run all CI checks (check, fmt, clippy, examples-build, tests)"
dependencies = ["check", "fmt-check", "clippy-check", "fmt-page-check", "examples-build", "test"]

# ============================================================================
# Documentation Tasks
# ============================================================================

[tasks.doc]
description = "Build documentation"
command = "cargo"
args = ["doc", "--workspace", "--all-features", "--no-deps"]

[tasks.doc-open]
description = "Build and open documentation"
command = "cargo"
args = ["doc", "--workspace", "--all-features", "--no-deps", "--open"]

# ============================================================================
# Utility Tasks
# ============================================================================

[tasks.outdated]
description = "Check for outdated dependencies"
command = "cargo"
args = ["outdated"]

[tasks.update]
description = "Update dependencies"
command = "cargo"
args = ["update"]

[tasks.tree]
description = "Display dependency tree"
command = "cargo"
args = ["tree", "--workspace"]

[tasks.bloat]
description = "Analyze binary bloat"
command = "cargo"
args = ["bloat", "--release"]

# ============================================================================
# Helper Tasks
# ============================================================================

[tasks.default]
description = "Default task - shows help"
command = "cargo"
args = ["make", "--list-all-steps"]

[tasks.help]
description = "Show available tasks"
command = "cargo"
args = ["make", "--list-all-steps"]

# ============================================================================
# Watch Tasks (using bacon)
# ============================================================================

[tasks.watch]
description = "Watch for changes and run checks (requires bacon)"
command = "bacon"
dependencies = ["install-bacon"]

[tasks.watch-test]
description = "Watch for changes and run tests (requires bacon)"
command = "bacon"
args = ["test"]
dependencies = ["install-bacon"]

[tasks.watch-clippy]
description = "Watch for changes and run clippy (requires bacon)"
command = "bacon"
args = ["clippy"]
dependencies = ["install-bacon"]

[tasks.install-bacon]
description = "Install bacon if not already installed"
script = '''
if ! command -v bacon &> /dev/null
then
	echo "Installing bacon..."
	cargo install --locked bacon
else
	echo "bacon is already installed"
fi
'''

# ============================================================================
# Examples Tasks
# ============================================================================

[tasks.local-examples-build]
description = "Build local examples (now part of workspace)"
command = "cargo"
args = [
  "build",
  "-p", "examples-hello-world",
  "-p", "examples-rest-api",
  "-p", "examples-database-integration",
  "-p", "examples-tutorial-basis",
  "-p", "examples-tutorial-rest",
  "-p", "examples-twitter",
  "-p", "examples-github-issues",
  "--release"
]

[tasks.remote-examples-build]
description = "Build remote examples individually (auto-detect examples-* directories)"
script = '''
#!/bin/bash

# Change to examples/remote directory
cd examples/remote

EXIT_CODE=0

# Find all directories starting with "examples-"
for example_dir in examples-*; do
  if [ -d "$example_dir" ]; then
    example_name=$(basename "$example_dir")
    echo ""
    echo "========================================"
    echo "Building $example_name..."
    echo "========================================"

    # Build and capture output to temporary file
    BUILD_LOG=$(mktemp)

    # Run build and capture both output and exit status
    # Use PIPESTATUS to get cargo's exit code (not tee's)
    (cd "$example_dir" && cargo build --release 2>&1 | tee "$BUILD_LOG"; exit ${PIPESTATUS[0]})
    BUILD_STATUS=$?

    if [ $BUILD_STATUS -eq 0 ]; then
      # Build succeeded
      echo "✅ $example_name built successfully"
      rm -f "$BUILD_LOG"
    else
      # Build failed - check if it's a version/dependency issue
      if grep -qE "failed to select a version|does not have that feature|no matching version|could not be found" "$BUILD_LOG"; then
        # Version/dependency issue - skip
        echo "⏭️  Skipping $example_name (dependency version mismatch)"
      else
        # Other error - treat as actual build failure
        echo "❌ Build failed: $example_name"
        echo "Last 30 lines of error:"
        tail -n 30 "$BUILD_LOG"
        EXIT_CODE=1
      fi
      rm -f "$BUILD_LOG"
    fi
  fi
done

exit $EXIT_CODE
'''

[tasks.examples-build]
description = "Build all examples (local + remote)"
dependencies = ["local-examples-build", "remote-examples-build"]

[tasks.local-examples-clean]
description = "Clean local examples build artifacts (now part of workspace clean)"
command = "cargo"
args = [
  "clean",
  "-p", "examples-hello-world",
  "-p", "examples-rest-api",
  "-p", "examples-database-integration",
  "-p", "examples-tutorial-basis",
  "-p", "examples-tutorial-rest",
  "-p", "examples-twitter",
  "-p", "examples-github-issues"
]

[tasks.remote-examples-clean]
description = "Clean remote examples build artifacts"
cwd = "examples/remote"
command = "cargo"
args = ["clean"]

[tasks.examples-clean]
description = "Clean all examples build artifacts"
dependencies = ["local-examples-clean", "remote-examples-clean"]

# ============================================================================
# Combined CI Tasks (including examples)
# ============================================================================

[tasks.ci-full]
description = "Run all CI checks including examples tests"
dependencies = ["check", "fmt", "clippy", "test", "examples-test"]

[tasks.ci-with-examples]
description = "Alias for ci-full"
dependencies = ["ci-full"]
