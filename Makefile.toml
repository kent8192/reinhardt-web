# Reinhardt - cargo-make configuration

[config]
default_to_workspace = false

# Environment variables
[env]
CARGO_TERM_COLOR = "always"
RUST_BACKTRACE = "1"
TEST_DATABASE_URL = "postgres://postgres:postgres@localhost:5432/test_db"
MYSQL_DATABASE_URL = "mysql://root:mysql@localhost:3306/test_db"
REDIS_URL = "redis://localhost:6379"
# Force TestContainers to use Docker instead of Podman
DOCKER_HOST = "unix:///var/run/docker.sock"
TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE = "/var/run/docker.sock"

# ============================================================================
# Core Development Tasks
# ============================================================================

[tasks.check]
description = "Run cargo check on workspace"
command = "cargo"
args = ["check", "--workspace", "--all", "--all-features"]

[tasks.build]
description = "Build workspace"
command = "cargo"
args = ["build", "--workspace", "--all", "--all-features"]

[tasks.build-release]
description = "Build workspace in release mode"
command = "cargo"
args = ["build", "--workspace", "--all", "--all-features", "--release"]

[tasks.clean]
description = "Clean build artifacts"
command = "cargo"
args = ["clean"]

# ============================================================================
# Code Quality Tasks
# ============================================================================

[tasks.fmt-check]
description = "Check code formatting (CI mode)"
command = "cargo"
args = ["fmt", "--check", "--all"]

[tasks.fmt-fix]
description = "Auto-fix code formatting"
command = "cargo"
args = ["fmt", "--all"]

[tasks.clippy-check]
description = "Run clippy linter"
command = "cargo"
args = [
    "clippy",
    "--workspace",
    "--all",
    "--all-features",
    "--",
    "-D",
    "warnings",
]

[tasks.clippy-fix]
description = "Run clippy linter and automatically fix found errors."
command = "cargo"
args = [
    "clippy",
    "--fix",
    "--workspace",
    "--all",
    "--all-features",
    "--allow-dirty",
    "--",
    "-D",
    "warnings",
]

[tasks.auto-fix]
description = "Run all tests"
dependencies = ["fmt-fix", "clippy-fix"]

# ============================================================================
# Testing Tasks
# ============================================================================

[tasks.doc-test]
description = "Run only documentation tests"
command = "cargo"
args = ["test", "--workspace", "--doc", "--all-features"]

[tasks.unit-test]
description = "Run unit tests and within-crate integration tests"
command = "cargo"
args = ["nextest", "run", "--workspace", "--lib", "--tests", "--exclude", "reinhardt-integration-tests", "--all-features", "--no-fail-fast"]

[tasks.integration-test]
description = "Run integration tests (requires PostgreSQL, MySQL, Redis)"
command = "cargo"
args = ["nextest", "run", "--package", "reinhardt-integration-tests", "--all-features", "--no-fail-fast"]

[tasks.test]
description = "Run all tests"
dependencies = ["doc-test", "unit-test", "integration-test"]

# ============================================================================
# CI Tasks
# ============================================================================

[tasks.ci]
description = "Run all CI checks (check, fmt, clippy, tests)"
dependencies = ["check", "fmt", "clippy", "test"]

# ============================================================================
# Documentation Tasks
# ============================================================================

[tasks.doc]
description = "Build documentation"
command = "cargo"
args = ["doc", "--workspace", "--all-features", "--no-deps"]

[tasks.doc-open]
description = "Build and open documentation"
command = "cargo"
args = ["doc", "--workspace", "--all-features", "--no-deps", "--open"]

# ============================================================================
# Utility Tasks
# ============================================================================

[tasks.outdated]
description = "Check for outdated dependencies"
command = "cargo"
args = ["outdated"]

[tasks.update]
description = "Update dependencies"
command = "cargo"
args = ["update"]

[tasks.tree]
description = "Display dependency tree"
command = "cargo"
args = ["tree", "--workspace"]

[tasks.bloat]
description = "Analyze binary bloat"
command = "cargo"
args = ["bloat", "--release"]

# ============================================================================
# Helper Tasks
# ============================================================================

[tasks.default]
description = "Default task - shows help"
command = "cargo"
args = ["make", "--list-all-steps"]

[tasks.help]
description = "Show available tasks"
command = "cargo"
args = ["make", "--list-all-steps"]

# ============================================================================
# Examples Tests Tasks
# ============================================================================

[tasks.examples-setup]
description = "Setup examples directory (.env file creation)"
cwd = "examples"
script = '''
if [ ! -f .env ]; then
  cp .env.example .env
  echo "‚úÖ .env file created"
else
  echo "‚ö†Ô∏è  .env file already exists"
fi
'''

[tasks.examples-up]
description = "Start infrastructure for examples (PostgreSQL)"
cwd = "examples"
script = '''
docker compose up -d postgres
echo "‚è≥ Waiting for PostgreSQL to start..."
sleep 5
echo "‚úÖ PostgreSQL started"
'''

[tasks.examples-down]
description = "Stop infrastructure for examples"
cwd = "examples"
script = '''
docker compose down
'''

[tasks.examples-test]
description = "Test all examples (requires reinhardt to be published to crates.io)"
dependencies = ["examples-up"]
cwd = "examples"
script = '''
echo "üß™ Running examples tests..."
cargo nextest run --workspace --verbose || (cd .. && cargo make examples-down && exit 1)
cd ..
cargo make examples-down
echo "‚úÖ Examples tests completed"
'''

[tasks.examples-test-keep]
description = "Test examples and keep infrastructure running"
dependencies = ["examples-up"]
cwd = "examples"
command = "cargo"
args = ["nextest", "run", "--workspace", "--verbose"]

[tasks.examples-check-published]
description = "Check if reinhardt is published to crates.io"
script = '''
if cargo search reinhardt | grep -q "^reinhardt ="; then
  echo "‚úÖ reinhardt is available on crates.io"
  exit 0
else
  echo "‚ö†Ô∏è reinhardt is NOT available on crates.io"
  echo "   Examples tests will be skipped"
  exit 1
fi
'''

[tasks.examples-update]
description = "Update examples dependencies from crates.io"
cwd = "examples"
command = "cargo"
args = ["update"]

[tasks.examples-build]
description = "Build all examples"
cwd = "examples"
command = "cargo"
args = ["build", "--workspace", "--release"]

[tasks.examples-clean]
description = "Clean examples build artifacts"
cwd = "examples"
command = "cargo"
args = ["clean"]

[tasks.examples-status]
description = "Check examples infrastructure status"
cwd = "examples"
script = '''
docker compose ps
'''

[tasks.examples-logs]
description = "Show examples infrastructure logs"
cwd = "examples"
script = '''
docker compose logs -f
'''

# ============================================================================
# Combined CI Tasks (including examples)
# ============================================================================

[tasks.ci-full]
description = "Run all CI checks including examples tests"
dependencies = ["check", "fmt", "clippy", "test", "examples-test"]

[tasks.ci-with-examples]
description = "Alias for ci-full"
dependencies = ["ci-full"]
