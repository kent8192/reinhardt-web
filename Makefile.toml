# Reinhardt - cargo-make configuration

[config]
default_to_workspace = false

# Environment variables
[env]
CARGO_TERM_COLOR = "always"
RUST_BACKTRACE = "1"
TEST_DATABASE_URL = "postgres://postgres:postgres@localhost:5432/test_db"
MYSQL_DATABASE_URL = "mysql://root:mysql@localhost:3306/test_db"
REDIS_URL = "redis://localhost:6379"
# Force TestContainers to use Docker instead of Podman
DOCKER_HOST = "unix:///var/run/docker.sock"
TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE = "/var/run/docker.sock"

# ============================================================================
# Core Development Tasks
# ============================================================================

[tasks.check]
description = "Run cargo check on workspace"
command = "cargo"
args = [
  "check",
  "--workspace",
  "--all",
  "--all-features",
  "--all-targets",
  "--tests",
  "--quiet"
]

[tasks.build]
description = "Build workspace"
command = "cargo"
args = ["build", "--workspace", "--all", "--all-features", "--all-targets", "--quiet"]

[tasks.build-release]
description = "Build workspace in release mode"
command = "cargo"
args = ["build", "--workspace", "--all", "--all-features", "--release", "--quiet"]

[tasks.clean]
description = "Clean build artifacts"
command = "cargo"
args = ["clean"]

# ============================================================================
# Code Quality Tasks
# ============================================================================

[tasks.fmt-check]
description = "Check code formatting (CI mode)"
command = "cargo"
args = ["fmt", "--check", "--all"]

[tasks.fmt-fix]
description = "Auto-fix code formatting"
command = "cargo"
args = ["fmt", "--all"]

[tasks.clippy-check]
description = "Run clippy linter"
command = "cargo"
args = [
  "clippy",
  "--workspace",
  "--all",
  "--all-features",
  "--",
  "-D",
  "warnings",
]

[tasks.clippy-fix]
description = "Run clippy linter and automatically fix found errors."
command = "cargo"
args = [
  "clippy",
  "--fix",
  "--workspace",
  "--all",
  "--all-features",
  "--allow-dirty",
  "--",
  "-D",
  "warnings",
]

[tasks.auto-fix]
description = "Run all tests"
dependencies = ["fmt-fix", "clippy-fix"]

# ============================================================================
# Testing Tasks
# ============================================================================

[tasks.doc-test]
description = "Run only documentation tests"
command = "cargo"
args = ["test", "--workspace", "--doc", "--quiet", "--all-features", "--no-fail-fast"]

[tasks.bench]
description = "Run benchmark tests in tests/bench"
command = "cargo"
args = ["bench", "--manifest-path", "tests/bench/Cargo.toml"]

[tasks.unit-test]
description = "Run unit tests (src/)"
command = "cargo"
args = [
  "nextest",
  "run",
  "--workspace",
  "--lib",
  "--exclude",
  "reinhardt-integration-tests",
  "--all-features",
  "--no-fail-fast",
  "--show-progress=none",
  "--status-level=none",
  "--final-status-level=none",
]

[tasks.intra-crate-integration-test]
description = "Run intra-crate integration tests (tests/)"
command = "cargo"
args = [
  "nextest",
  "run",
  "--workspace",
  "--test",
  "*",
  "--exclude",
  "reinhardt-integration-tests",
  "--all-features",
  "--no-fail-fast",
  "--show-progress=none",
  "--status-level=none",
  "--final-status-level=none"
]

[tasks.cross-crate-integration-test]
description = "Run cross-crate integration tests (reinhardt-integration-tests)"
command = "cargo"
args = [
  "nextest",
  "run",
  "--package",
  "reinhardt-integration-tests",
  "--all-features",
  "--no-fail-fast",
  "--show-progress=none",
  "--status-level=none",
  "--final-status-level=none"
]

[tasks.integration-test]
description = "Run all integration tests"
dependencies = ["intra-crate-integration-test", "cross-crate-integration-test"]

[tasks.local-examples-test]
description = "Test local examples (uses local reinhardt workspace)"
cwd = "examples/local"
command = "cargo"
args = ["nextest", "run", "--workspace", "--verbose"]

[tasks.remote-examples-test]
description = "Test remote examples (uses crates.io published versions)"
cwd = "examples/remote"
command = "cargo"
args = ["nextest", "run", "--workspace", "--verbose"]

[tasks.examples-test]
description = "Test all examples (local + remote)"
dependencies = ["local-examples-test", "remote-examples-test"]

[tasks.test]
description = "Run all tests"
dependencies = [
  "unit-test",
  "integration-test",
  "doc-test",
  "examples-test",
]

# ============================================================================
# CI Tasks
# ============================================================================

[tasks.ci]
description = "Run all CI checks (check, fmt, clippy, examples-build, tests)"
dependencies = ["check", "fmt-check", "clippy-check", "examples-build", "test"]

# ============================================================================
# Documentation Tasks
# ============================================================================

[tasks.doc]
description = "Build documentation"
command = "cargo"
args = ["doc", "--workspace", "--all-features", "--no-deps"]

[tasks.doc-open]
description = "Build and open documentation"
command = "cargo"
args = ["doc", "--workspace", "--all-features", "--no-deps", "--open"]

# ============================================================================
# Utility Tasks
# ============================================================================

[tasks.outdated]
description = "Check for outdated dependencies"
command = "cargo"
args = ["outdated"]

[tasks.update]
description = "Update dependencies"
command = "cargo"
args = ["update"]

[tasks.tree]
description = "Display dependency tree"
command = "cargo"
args = ["tree", "--workspace"]

[tasks.bloat]
description = "Analyze binary bloat"
command = "cargo"
args = ["bloat", "--release"]

# ============================================================================
# Helper Tasks
# ============================================================================

[tasks.default]
description = "Default task - shows help"
command = "cargo"
args = ["make", "--list-all-steps"]

[tasks.help]
description = "Show available tasks"
command = "cargo"
args = ["make", "--list-all-steps"]

# ============================================================================
# Watch Tasks (using bacon)
# ============================================================================

[tasks.watch]
description = "Watch for changes and run checks (requires bacon)"
command = "bacon"
dependencies = ["install-bacon"]

[tasks.watch-test]
description = "Watch for changes and run tests (requires bacon)"
command = "bacon"
args = ["test"]
dependencies = ["install-bacon"]

[tasks.watch-clippy]
description = "Watch for changes and run clippy (requires bacon)"
command = "bacon"
args = ["clippy"]
dependencies = ["install-bacon"]

[tasks.install-bacon]
description = "Install bacon if not already installed"
script = '''
if ! command -v bacon &> /dev/null
then
	echo "Installing bacon..."
	cargo install --locked bacon
else
	echo "bacon is already installed"
fi
'''

# ============================================================================
# Examples Tasks
# ============================================================================

[tasks.local-examples-build]
description = "Build local examples individually (auto-detect examples-* directories)"
script = '''
#!/bin/bash
set -e

# Change to examples/local directory
cd examples/local

# Find all directories starting with "examples-"
for example_dir in examples-*; do
  if [ -d "$example_dir" ]; then
    example_name=$(basename "$example_dir")
    echo "Building $example_name..."
    cargo build -p "$example_name" --release
  fi
done
'''

[tasks.remote-examples-build]
description = "Build remote examples individually (auto-detect examples-* directories)"
script = '''
#!/bin/bash

# Change to examples/remote directory
cd examples/remote

EXIT_CODE=0

# Find all directories starting with "examples-"
for example_dir in examples-*; do
  if [ -d "$example_dir" ]; then
    example_name=$(basename "$example_dir")
    echo ""
    echo "========================================"
    echo "Building $example_name..."
    echo "========================================"

    # Build and capture output to temporary file
    BUILD_LOG=$(mktemp)

    # Run build and capture both output and exit status
    # Use PIPESTATUS to get cargo's exit code (not tee's)
    (cd "$example_dir" && cargo build --release 2>&1 | tee "$BUILD_LOG"; exit ${PIPESTATUS[0]})
    BUILD_STATUS=$?

    if [ $BUILD_STATUS -eq 0 ]; then
      # Build succeeded
      echo "✅ $example_name built successfully"
      rm -f "$BUILD_LOG"
    else
      # Build failed - check if it's a version/dependency issue
      if grep -qE "failed to select a version|does not have that feature|no matching version|could not be found" "$BUILD_LOG"; then
        # Version/dependency issue - skip
        echo "⏭️  Skipping $example_name (dependency version mismatch)"
      else
        # Other error - treat as actual build failure
        echo "❌ Build failed: $example_name"
        echo "Last 30 lines of error:"
        tail -n 30 "$BUILD_LOG"
        EXIT_CODE=1
      fi
      rm -f "$BUILD_LOG"
    fi
  fi
done

exit $EXIT_CODE
'''

[tasks.examples-build]
description = "Build all examples (local + remote)"
dependencies = ["local-examples-build", "remote-examples-build"]

[tasks.local-examples-clean]
description = "Clean local examples build artifacts"
cwd = "examples/local"
command = "cargo"
args = ["clean"]

[tasks.remote-examples-clean]
description = "Clean remote examples build artifacts"
cwd = "examples/remote"
command = "cargo"
args = ["clean"]

[tasks.examples-clean]
description = "Clean all examples build artifacts"
dependencies = ["local-examples-clean", "remote-examples-clean"]

# ============================================================================
# Combined CI Tasks (including examples)
# ============================================================================

[tasks.ci-full]
description = "Run all CI checks including examples tests"
dependencies = ["check", "fmt", "clippy", "test", "examples-test"]

[tasks.ci-with-examples]
description = "Alias for ci-full"
dependencies = ["ci-full"]
