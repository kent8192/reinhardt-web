name: Publish on Merge

on:
  pull_request:
    types: [closed]
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  publish-on-merge:
    name: Publish changed crates to crates.io
    runs-on: ubuntu-latest
    environment: release  # Required for Trusted Publishing
    # Only run when PR is merged and has 'release' label
    if: |
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'release')

    permissions:
      contents: write  # Required for creating tags and GitHub Releases
      id-token: write  # Required for Trusted Publishing (OIDC)

    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history needed for cargo-workspaces
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.91.1

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version

      - name: Clean cargo cache
        run: cargo clean

      - name: Cache cargo registry
        uses: actions/cache@v5
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v5
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-workspaces
        run: cargo install cargo-workspaces

      - name: Authenticate to crates.io
        id: auth
        env:
          FALLBACK_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          # Try Trusted Publishing (OIDC) first
          echo "Attempting Trusted Publishing authentication..."

          # Get OIDC token from GitHub
          OIDC_TOKEN=$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=crates.io" | jq -r '.value')

          if [ -n "$OIDC_TOKEN" ] && [ "$OIDC_TOKEN" != "null" ]; then
            # Exchange OIDC token for crates.io token
            RESPONSE=$(curl -sS -X POST "https://crates.io/api/v1/trusted_publishing/tokens" \
              -H "Content-Type: application/json" \
              -d "{\"jwt\": \"$OIDC_TOKEN\"}" 2>&1)

            TOKEN=$(echo "$RESPONSE" | jq -r '.token // empty')

            if [ -n "$TOKEN" ]; then
              echo "âœ… Trusted Publishing authentication successful"
              echo "token=$TOKEN" >> $GITHUB_OUTPUT
              echo "auth_method=trusted_publishing" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âš ï¸ Trusted Publishing token exchange failed"
              echo "Response: $RESPONSE"
            fi
          else
            echo "âš ï¸ Failed to get OIDC token from GitHub"
          fi

          # Fallback to API token
          echo "Falling back to API token authentication..."
          if [ -n "$FALLBACK_TOKEN" ]; then
            echo "âœ… Using API token for authentication"
            echo "token=$FALLBACK_TOKEN" >> $GITHUB_OUTPUT
            echo "auth_method=api_token" >> $GITHUB_OUTPUT
          else
            echo "âŒ No authentication method available"
            echo "Please either:"
            echo "  1. Configure Trusted Publishing on crates.io for this repository"
            echo "  2. Set CARGO_REGISTRY_TOKEN secret in GitHub repository settings"
            exit 1
          fi

      - name: Display authentication method
        run: |
          echo "Authentication method: ${{ steps.auth.outputs.auth_method }}"

      - name: Detect crates to publish
        id: detect-crates
        run: |
          echo "Detecting crates to publish using cargo ws plan..."

          # Use cargo ws plan to get crates in dependency-aware publishing order
          # --skip-published excludes already published versions
          PLAN_JSON=$(cargo ws plan --json --skip-published 2>/dev/null || cargo ws plan --json 2>/dev/null)

          if [ -z "$PLAN_JSON" ] || [ "$PLAN_JSON" = "[]" ]; then
            echo "No crates to publish."
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Crates in publishing order (from cargo ws plan):"
          echo "$PLAN_JSON" | jq -r '.[] | "  - \(.name) v\(.version)"'

          # Filter to only public crates and build final JSON
          CRATES_JSON="["
          FIRST=true

          for row in $(echo "$PLAN_JSON" | jq -c '.[]'); do
            CRATE_NAME=$(echo "$row" | jq -r '.name')
            VERSION=$(echo "$row" | jq -r '.version')
            IS_PRIVATE=$(echo "$row" | jq -r '.private')

            # Skip private crates
            if [ "$IS_PRIVATE" = "true" ]; then
              echo "â„¹ï¸ Skipping private crate: $CRATE_NAME"
              continue
            fi

            # Double-check if already published (cargo ws plan --skip-published may not catch all cases)
            if curl -s "https://crates.io/api/v1/crates/$CRATE_NAME/$VERSION" | grep -q "\"num\":\"$VERSION\""; then
              echo "â„¹ï¸ $CRATE_NAME@$VERSION already published, skipping..."
              continue
            fi

            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              CRATES_JSON="${CRATES_JSON},"
            fi

            CRATES_JSON="${CRATES_JSON}{\"name\":\"${CRATE_NAME}\",\"version\":\"${VERSION}\"}"
            echo "ðŸ“¦ Will publish: $CRATE_NAME v$VERSION"
          done

          CRATES_JSON="${CRATES_JSON}]"

          if [ "$CRATES_JSON" = "[]" ]; then
            echo "No crates to publish (all may be already published)."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "crates_json=$CRATES_JSON" >> $GITHUB_OUTPUT
            echo ""
            echo "Publishing order determined by cargo ws plan (dependency-aware)."
          fi

      - name: Publish crates using cargo-workspaces
        if: steps.detect-crates.outputs.has_changes == 'true'
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          echo "Publishing crates using cargo ws publish..."
          echo "cargo-workspaces automatically:"
          echo "  - Resolves dependency order"
          echo "  - Removes dev-dependencies (fixes circular dev-deps issue)"
          echo "  - Waits between publishes for crates.io index updates"
          echo "  - Creates and pushes tags for each published crate"
          echo ""

          # Use cargo ws publish with appropriate flags:
          # --from-git: Skip version bump (already committed)
          # --no-global-tag: Don't create workspace-wide tag (only per-crate tags)
          # --individual-tag-prefix '%n@': Tag format prefix (crate-name@)
          # --tag-prefix 'v': Tag format suffix (v before version)
          # Combined format: [crate-name]@v[version]
          # --publish-interval 30: Wait 30s between publishes for crates.io index
          # --yes: Skip confirmation prompts
          # --allow-dirty: Allow uncommitted changes (dev-deps removal)
          cargo ws publish \
            --from-git \
            --no-global-tag \
            --individual-tag-prefix '%n@' \
            --tag-prefix 'v' \
            --publish-interval 30 \
            --yes \
            --allow-dirty

          echo ""
          echo "ðŸŽ‰ All crates published and tagged successfully!"

      - name: Create GitHub Releases
        if: steps.detect-crates.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CRATES_JSON='${{ steps.detect-crates.outputs.crates_json }}'

          echo "Creating GitHub Releases..."

          echo "$CRATES_JSON" | jq -c '.[]' | while read -r crate; do
            CRATE_NAME=$(echo "$crate" | jq -r '.name')
            VERSION=$(echo "$crate" | jq -r '.version')
            TAG_NAME="${CRATE_NAME}@v${VERSION}"

            # Find CHANGELOG
            CRATE_DIR=$(find crates -type f -name "Cargo.toml" -exec dirname {} \; | \
              xargs -I {} sh -c 'grep -l "name = \"'"$CRATE_NAME"'\"" {}/Cargo.toml 2>/dev/null && echo {}' | head -1)

            if [ -n "$CRATE_DIR" ] && [ -f "$CRATE_DIR/CHANGELOG.md" ]; then
              # Extract release notes for this version
              NOTES=$(awk "/## \[$VERSION\]/,/## \[/" "$CRATE_DIR/CHANGELOG.md" | head -n -1)

              if [ -z "$NOTES" ]; then
                NOTES="Release $CRATE_NAME v$VERSION

          Published to crates.io"
              fi
            else
              NOTES="Release $CRATE_NAME v$VERSION

          Published to crates.io"
            fi

            echo "$NOTES" > /tmp/release-notes-${CRATE_NAME}.md

            # Create GitHub Release
            gh release create "$TAG_NAME" \
              --title "Release $CRATE_NAME v$VERSION" \
              --notes-file /tmp/release-notes-${CRATE_NAME}.md

            echo "âœ… Created GitHub Release for $TAG_NAME"
          done

      - name: Summary
        if: steps.detect-crates.outputs.has_changes == 'true'
        run: |
          CRATES_JSON='${{ steps.detect-crates.outputs.crates_json }}'

          {
            echo "## ðŸŽ‰ Release Successful"
            echo ""
            echo "The following crates were published to crates.io (in dependency order):"
            echo ""
            echo "$CRATES_JSON" | jq -r '.[] | "- [\(.name) v\(.version)](https://crates.io/crates/\(.name)/\(.version))"'
            echo ""
            echo "### Documentation"
            echo ""
            echo "Documentation will be available shortly on docs.rs:"
            echo ""
            echo "$CRATES_JSON" | jq -r '.[] | "- [\(.name)](https://docs.rs/\(.name)/\(.version))"'
          } >> $GITHUB_STEP_SUMMARY
