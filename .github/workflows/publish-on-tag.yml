# DISABLED: Publishing is now handled by publish-on-merge.yml
# This workflow is kept for emergency manual releases.
# To trigger manually: GitHub Actions â†’ Publish on Tag (Manual) â†’ Run workflow

name: Publish on Tag (Manual Only)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to publish (e.g., reinhardt-core@v0.1.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  validate-tag:
    name: Validate tag
    runs-on: ubuntu-latest
    outputs:
      crate_name: ${{ steps.extract.outputs.crate_name }}
      version: ${{ steps.extract.outputs.version }}
      is_valid: ${{ steps.validate.outputs.is_valid }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract crate name and version from tag
        id: extract
        run: |
          TAG_NAME="${{ github.event.inputs.tag }}"
          echo "Tag: $TAG_NAME"

          # Extract crate name (everything before @vX.Y.Z)
          CRATE_NAME=$(echo "$TAG_NAME" | sed 's/@v[0-9].*//')

          # Extract version (everything after @v)
          VERSION=$(echo "$TAG_NAME" | sed 's/.*@v//')

          echo "Crate: $CRATE_NAME"
          echo "Version: $VERSION"

          echo "crate_name=$CRATE_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Validate tag exists
        id: validate
        run: |
          TAG_NAME="${{ github.event.inputs.tag }}"

          # Check if tag exists
          if ! git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "âŒ Tag $TAG_NAME does not exist"
            echo "::error::Tag must exist before publishing"
            echo "is_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Check if tag is ancestor of main
          if git merge-base --is-ancestor "$TAG_NAME" origin/main; then
            echo "âœ… Tag $TAG_NAME is on main branch"
            echo "is_valid=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Tag $TAG_NAME is NOT on main branch"
            echo "::error::Tag must be created from main branch"
            echo "is_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  verify-version:
    name: Verify version matches
    needs: validate-tag
    runs-on: ubuntu-latest
    if: needs.validate-tag.outputs.is_valid == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@1.91.1

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Verify Cargo.toml version matches tag
        env:
          CRATE_NAME: ${{ needs.validate-tag.outputs.crate_name }}
          TAG_VERSION: ${{ needs.validate-tag.outputs.version }}
        run: |
          echo "Verifying version for crate: $CRATE_NAME"

          # Find Cargo.toml for this crate
          CARGO_VERSION=$(cargo metadata --no-deps --format-version 1 | \
            jq -r ".packages[] | select(.name == \"$CRATE_NAME\") | .version")

          if [ -z "$CARGO_VERSION" ] || [ "$CARGO_VERSION" == "null" ]; then
            echo "::error::Crate $CRATE_NAME not found in workspace"
            exit 1
          fi

          echo "Cargo.toml version: $CARGO_VERSION"
          echo "Tag version: $TAG_VERSION"

          if [ "$CARGO_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::Version mismatch! Cargo.toml=$CARGO_VERSION, Tag=$TAG_VERSION"
            exit 1
          fi

          echo "âœ… Version matches!"

  publish:
    name: Publish to crates.io
    needs: [validate-tag, verify-version]
    runs-on: ubuntu-latest

    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@1.91.1

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-workspaces
        run: cargo install cargo-workspaces

      - name: Run final dry-run
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          CRATE_NAME: ${{ needs.validate-tag.outputs.crate_name }}
        run: |
          echo "Running final dry-run for $CRATE_NAME..."
          cargo ws publish --dry-run -p "$CRATE_NAME"

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          CRATE_NAME: ${{ needs.validate-tag.outputs.crate_name }}
        run: |
          echo "Publishing $CRATE_NAME to crates.io..."

          # Retry logic with exponential backoff
          MAX_RETRIES=3
          RETRY_COUNT=0
          WAIT_TIME=10

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if cargo ws publish -p "$CRATE_NAME" --no-git-push; then
              echo "âœ… Successfully published $CRATE_NAME"
              exit 0
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "âš ï¸ Publish failed, retrying in ${WAIT_TIME}s (attempt $RETRY_COUNT/$MAX_RETRIES)..."
                sleep $WAIT_TIME
                WAIT_TIME=$((WAIT_TIME * 2))  # Exponential backoff
              else
                echo "âŒ Publish failed after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done

      - name: Wait for crates.io index update
        run: |
          echo "Waiting 30 seconds for crates.io index to update..."
          sleep 30

  create-release:
    name: Create GitHub Release
    needs: [validate-tag, publish]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract release notes from CHANGELOG
        id: release-notes
        env:
          CRATE_NAME: ${{ needs.validate-tag.outputs.crate_name }}
          VERSION: ${{ needs.validate-tag.outputs.version }}
        run: |
          # Find crate directory
          CRATE_DIR=$(find crates -type f -name "Cargo.toml" -exec dirname {} \; | \
            xargs -I {} sh -c 'grep -l "name = \"$CRATE_NAME\"" {}/Cargo.toml 2>/dev/null && echo {}' | head -1)

          if [ -z "$CRATE_DIR" ]; then
            echo "Crate directory not found for $CRATE_NAME"
            CHANGELOG_PATH=""
          else
            CHANGELOG_PATH="$CRATE_DIR/CHANGELOG.md"
          fi

          # Extract release notes for this version
          if [ -f "$CHANGELOG_PATH" ]; then
            echo "Found CHANGELOG at $CHANGELOG_PATH"

            # Extract section for this version
            NOTES=$(awk "/## \[$VERSION\]/,/## \[/" "$CHANGELOG_PATH" | head -n -1)

            if [ -z "$NOTES" ]; then
              NOTES=$(cat <<EOF
          Release $CRATE_NAME v$VERSION

          No CHANGELOG entry found for this version.
          EOF
              )
            fi
          else
            echo "No CHANGELOG.md found"
            NOTES=$(cat <<EOF
          Release $CRATE_NAME v$VERSION

          Published to crates.io
          EOF
            )
          fi

          # Save to file
          echo "$NOTES" > /tmp/release-notes.md

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ github.event.inputs.tag }}
          CRATE_NAME: ${{ needs.validate-tag.outputs.crate_name }}
          VERSION: ${{ needs.validate-tag.outputs.version }}
        run: |
          gh release create "$TAG_NAME" \
            --title "Release $CRATE_NAME v$VERSION" \
            --notes-file /tmp/release-notes.md

      - name: Summary
        env:
          CRATE_NAME: ${{ needs.validate-tag.outputs.crate_name }}
          VERSION: ${{ needs.validate-tag.outputs.version }}
        run: |
          echo "## ðŸŽ‰ Manual Release Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Crate:** \`${CRATE_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "- [crates.io](https://crates.io/crates/${CRATE_NAME}/${VERSION})" >> $GITHUB_STEP_SUMMARY
          echo "- [docs.rs](https://docs.rs/${CRATE_NAME}/${VERSION})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The crate is now available on crates.io and docs.rs will build documentation shortly." >> $GITHUB_STEP_SUMMARY
