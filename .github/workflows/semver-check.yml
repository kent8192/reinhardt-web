name: SemVer Check

on:
  workflow_call:
    inputs:
      runner:
        description: 'Runner label JSON'
        type: string
        default: '"ubuntu-latest"'
      cargo-build-jobs:
        description: "Parallel cargo build jobs"
        type: string
        default: "1"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  CARGO_BUILD_JOBS: ${{ inputs.cargo-build-jobs || '1' }}

jobs:
  semver-checks:
    name: SemVer Compatibility Check
    runs-on: ${{ fromJSON(inputs.runner || '"ubuntu-latest"') }}
    timeout-minutes: 30
    steps:
      - name: Free Disk Space (Ubuntu)
        if: ${{ !contains(inputs.runner || '', 'self-hosted') }}
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          # fetch-depth: 0 is required for --baseline-rev to access the full git history.
          # cargo-semver-checks needs to checkout and build the baseline commit, which
          # is not possible with a shallow clone (fetch-depth: 1, the default).
          fetch-depth: 0

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Setup protoc
        uses: ./.github/actions/setup-protoc

      - name: Install cargo-semver-checks
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get latest release tag via GitHub API (no gh CLI dependency)
          LATEST_TAG=$(curl -fsSL -H "Authorization: Bearer ${GH_TOKEN}" \
            "https://api.github.com/repos/obi1kenobi/cargo-semver-checks/releases/latest" \
            | jq -r '.tag_name')
          curl -fsSL -o /tmp/cargo-semver-checks.tar.gz \
            "https://github.com/obi1kenobi/cargo-semver-checks/releases/download/${LATEST_TAG}/cargo-semver-checks-x86_64-unknown-linux-musl.tar.gz"
          mkdir -p /tmp/csc
          tar xzf /tmp/cargo-semver-checks.tar.gz -C /tmp/csc/
          mv /tmp/csc/cargo-semver-checks ~/.cargo/bin/
          rm -rf /tmp/csc /tmp/cargo-semver-checks.tar.gz

      # On release-plz Release PRs, run the full semver-check using version numbers
      # from Cargo.toml to validate the complete release (major/minor/patch).
      # release-plz bumps versions in Cargo.toml, so cargo-semver-checks can auto-detect
      # the intended release type and verify compliance.
      - name: Run cargo-semver-checks (release PR - full version check)
        if: ${{ startsWith(github.head_ref || github.ref_name, 'release-plz-') }}
        env:
          # Use the PR base branch SHA as the baseline since crates are not yet published
          # to crates.io. This compares SemVer compatibility against the main branch state.
          # github.event.pull_request.base.sha is a git commit SHA (hex string), safe to use.
          BASELINE_REV: ${{ github.event.pull_request.base.sha }}
        run: |
          cargo semver-checks check-release \
            --workspace \
            --exclude reinhardt-web \
            --exclude reinhardt-pages \
            --all-features \
            --baseline-rev "${BASELINE_REV:-HEAD~1}"

      # Detect if any commits in the PR contain breaking change indicators
      # (! suffix on type or BREAKING CHANGE: in body) to auto-select release type.
      - name: Detect breaking changes in commits
        if: ${{ !startsWith(github.head_ref || github.ref_name, 'release-plz-') }}
        id: detect-breaking
        run: |
          COMMITS=$(git log --format="%s%n%b" origin/main..HEAD)
          if echo "$COMMITS" | grep -qE '^\w+(\(.+\))?!:|BREAKING CHANGE:'; then
            echo "release_type=major" >> "$GITHUB_OUTPUT"
          else
            echo "release_type=minor" >> "$GITHUB_OUTPUT"
          fi

      # On normal PRs, use auto-detected release type: minor for non-breaking
      # changes, major when breaking change indicators are found in commits.
      - name: Run cargo-semver-checks (normal PR)
        if: ${{ !startsWith(github.head_ref || github.ref_name, 'release-plz-') }}
        env:
          BASELINE_REV: ${{ github.event.pull_request.base.sha }}
        run: |
          cargo semver-checks check-release \
            --workspace \
            --exclude reinhardt-web \
            --exclude reinhardt-pages \
            --all-features \
            --release-type ${{ steps.detect-breaking.outputs.release_type }} \
            --baseline-rev "${BASELINE_REV:-HEAD~1}"
