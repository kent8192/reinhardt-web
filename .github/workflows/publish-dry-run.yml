name: Publish Dry-Run

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, labeled]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  dry-run:
    name: Dry-run publish check
    runs-on: ubuntu-latest
    # Only run for PRs with 'release' label
    if: contains(github.event.pull_request.labels.*.name, 'release')

    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for cargo-workspaces

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@1.91.1

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version

      - name: Clean cargo cache
        run: cargo clean

      - name: Cache cargo registry
        uses: actions/cache@v5
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v5
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-workspaces
        run: cargo install cargo-workspaces

      - name: Verify workspace build
        run: |
          echo "Verifying workspace can build..."
          cargo check --workspace --all-features
          echo "‚úÖ Workspace verification passed"

      - name: Detect changed crates
        id: detect-crates
        run: |
          echo "Detecting changed crates..."

          # Use cargo-workspaces to detect changed crates
          CHANGED_OUTPUT=$(cargo ws changed 2>&1 || true)

          if echo "$CHANGED_OUTPUT" | grep -q "No changed crates detected"; then
            echo "No changed crates detected."
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "::notice::No crates need publishing"
            exit 0
          fi

          echo "Changed crates found:"
          echo "$CHANGED_OUTPUT"
          echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Check crates.io version status
        if: steps.detect-crates.outputs.has_changes == 'true'
        run: |
          echo "::group::Checking crates.io version status"

          HAS_CONFLICT=false

          # Get changed crates
          CHANGED_CRATES=$(cargo ws changed 2>&1 | grep -v "^$" || true)

          for CRATE_NAME in $CHANGED_CRATES; do
            # Get proposed version from cargo metadata
            PROPOSED_VERSION=$(cargo metadata --format-version 1 --no-deps \
              | jq -r --arg name "$CRATE_NAME" '.packages[] | select(.name == $name) | .version')

            if [ -z "$PROPOSED_VERSION" ]; then
              echo "‚ö†Ô∏è Could not determine version for $CRATE_NAME, skipping"
              continue
            fi

            echo "Checking $CRATE_NAME v$PROPOSED_VERSION on crates.io..."

            # Query crates.io API with required User-Agent header
            HTTP_RESPONSE=$(curl -s -w "\n%{http_code}" \
              -H "User-Agent: reinhardt-ci (https://github.com/kent8192/reinhardt-rs)" \
              "https://crates.io/api/v1/crates/$CRATE_NAME")

            HTTP_BODY=$(echo "$HTTP_RESPONSE" | head -n -1)
            HTTP_STATUS=$(echo "$HTTP_RESPONSE" | tail -n 1)

            if [ "$HTTP_STATUS" = "404" ]; then
              echo "  ‚ÑπÔ∏è $CRATE_NAME: Not yet published on crates.io (new crate) - OK"
              sleep 1
              continue
            fi

            if [ "$HTTP_STATUS" != "200" ]; then
              echo "  ‚ö†Ô∏è $CRATE_NAME: crates.io API returned HTTP $HTTP_STATUS, skipping check"
              sleep 1
              continue
            fi

            # Extract published versions
            PUBLISHED_MAX=$(echo "$HTTP_BODY" | jq -r '.crate.max_version // empty')
            VERSION_EXISTS=$(echo "$HTTP_BODY" | jq -r \
              --arg ver "$PROPOSED_VERSION" \
              '[.versions[]? | select(.num == $ver)] | length > 0')

            if [ "$VERSION_EXISTS" = "true" ]; then
              echo "  ‚ùå $CRATE_NAME: Version $PROPOSED_VERSION is ALREADY PUBLISHED on crates.io!"
              echo "::error::$CRATE_NAME v$PROPOSED_VERSION is already published on crates.io. Bump the version before publishing."
              HAS_CONFLICT=true
            else
              echo "  ‚úÖ $CRATE_NAME: Version $PROPOSED_VERSION is available"
              # Warn about unnatural version jumps
              if [ -n "$PUBLISHED_MAX" ] && [ "$PUBLISHED_MAX" != "null" ]; then
                echo "     Current max on crates.io: $PUBLISHED_MAX ‚Üí Proposed: $PROPOSED_VERSION"
              fi
            fi

            # Rate limit: 1 second between API calls (crates.io policy)
            sleep 1
          done

          echo "::endgroup::"

          if [ "$HAS_CONFLICT" = "true" ]; then
            echo "=========================================="
            echo "‚ùå Version conflict detected!"
            echo "=========================================="
            echo "One or more crates have versions already published on crates.io."
            echo "Please bump the version(s) before proceeding."
            exit 1
          fi

          echo "=========================================="
          echo "‚úÖ crates.io version status check passed"
          echo "=========================================="

      - name: Run publish dry-run for changed crates
        if: steps.detect-crates.outputs.has_changes == 'true'
        run: |
          echo "::group::Running cargo ws publish --dry-run"

          # Run cargo ws publish --dry-run and capture output
          set +e  # Don't exit on error (exit code is always 0)
          OUTPUT=$(cargo ws publish --dry-run 2>&1)
          CARGO_EXIT=$?
          set -e

          # Display full output
          echo "$OUTPUT"
          echo ""

          # Check for error patterns in output
          # Filter out dependency resolution errors (expected for initial release)
          # These errors occur when dependent crates are not yet published to crates.io
          # Cargo may report these as:
          # - "no matching package named `<crate>`" (older Cargo versions)
          # - "failed to select a version for the requirement `<crate> = \"<version>\"`" (newer Cargo versions)
          DEPENDENCY_ERRORS=$(echo "$OUTPUT" | grep -E "no matching package named|failed to select a version for the requirement" || true)

          # If there are dependency errors, also filter out related cascading errors
          # These include:
          # - "failed to prepare local package for uploading" (direct consequence of missing deps)
          # - "failed to parse manifest" (Cargo cannot resolve deps in manifest)
          # - "failed to select a version for the requirement" (version resolution failure)
          if [ -n "$DEPENDENCY_ERRORS" ]; then
            FILTERED_ERRORS=$(echo "$OUTPUT" | grep -E "error:|failed to|Failed to|ERROR|Error" | grep -v "no matching package named" | grep -v "failed to prepare local package for uploading" | grep -v "failed to parse manifest" | grep -v "failed to select a version for the requirement" || true)
          else
            FILTERED_ERRORS=$(echo "$OUTPUT" | grep -E "error:|failed to|Failed to|ERROR|Error" || true)
          fi

          if [ -n "$FILTERED_ERRORS" ]; then
            echo "=========================================="
            echo "‚ùå Publish dry-run detected errors"
            echo "=========================================="
            echo ""
            echo "Error details:"
            echo "$FILTERED_ERRORS"
            echo ""
            echo "::error::Publish dry-run failed. Check output above for details."
            exit 1
          fi

          # Warn about dependency errors (expected for initial release)
          if [ -n "$DEPENDENCY_ERRORS" ]; then
            echo "=========================================="
            echo "‚ö†Ô∏è Dependency resolution errors detected (expected for initial release)"
            echo "=========================================="
            echo ""
            echo "The following dependencies are not yet published to crates.io:"
            # Extract crate names from both error message formats:
            # - "no matching package named `<crate>`"
            # - "failed to select a version for the requirement `<crate> = \"<version>\"`"
            echo "$DEPENDENCY_ERRORS" | grep -oP "(no matching package named|for the requirement) \`\K[^\`=]+" | sed 's/ *$//' | sort -u | sed 's/^/  - /'
            echo ""
            echo "This is expected for initial release. The actual publish workflow"
            echo "will publish crates in dependency order, resolving these errors."
            echo ""
            echo "::warning::Dependency errors detected but allowed for initial release."
          fi

          # Check for warning patterns
          if echo "$OUTPUT" | grep -qE "warning:|WARNING|Warning"; then
            echo "::warning::Publish dry-run completed with warnings. Review output above."
          fi

          echo "=========================================="
          echo "‚úÖ Publish dry-run completed successfully"
          echo "=========================================="
          echo "::notice::All publish dry-run checks passed"

          echo "::endgroup::"

      - name: Summary
        if: always() && steps.detect-crates.outputs.has_changes == 'true'
        run: |
          {
            echo "## üìã Publish Dry-Run Check"
            echo ""
            echo "All changed crates were validated using \`cargo ws publish --dry-run\`."
            echo ""
            echo "### Verification Performed"
            echo "- ‚úÖ Workspace build check (\`cargo check --workspace --all-features\`)"
            echo "- ‚úÖ crates.io version conflict check"
            echo "- ‚úÖ Publish dry-run (\`cargo ws publish --dry-run\`)"
            echo "- ‚úÖ Packaging, dependency resolution, and manifest validation"
            echo "- ‚úÖ Output analysis for error detection"
            echo ""
            echo "### Next Steps"
            echo ""
            echo "If all checks passed, this PR is ready to merge."
            echo "Upon merge, the 'publish-on-merge' workflow will:"
            echo "1. Verify build for each crate"
            echo "2. Publish changed crates to crates.io in dependency order"
            echo "3. Create GitHub Releases"
            echo "4. Push release tags"
          } >> $GITHUB_STEP_SUMMARY

      - name: No changes summary
        if: always() && steps.detect-crates.outputs.has_changes == 'false'
        run: |
          {
            echo "## ‚ÑπÔ∏è No Crates to Publish"
            echo ""
            echo "No crates have changed since the last release."
            echo ""
            echo "**Note:** This PR has the \`release\` label but no crates need publishing."
            echo "Consider removing the \`release\` label if this is not a release PR."
          } >> $GITHUB_STEP_SUMMARY
