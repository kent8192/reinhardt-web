name: Publish Dry-Run

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, labeled]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  dry-run:
    name: Dry-run publish check
    runs-on: ubuntu-latest
    # Only run for PRs with 'release' label
    if: contains(github.event.pull_request.labels.*.name, 'release')

    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for cargo-workspaces

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@1.91.1

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-workspaces
        run: cargo install cargo-workspaces

      - name: Detect changed crates
        id: detect-crates
        run: |
          echo "Detecting changed crates..."

          # Use cargo-workspaces to detect changed crates
          CHANGED_OUTPUT=$(cargo ws changed 2>&1 || true)

          if echo "$CHANGED_OUTPUT" | grep -q "No changed crates detected"; then
            echo "No changed crates detected."
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "::notice::No crates need publishing"
            exit 0
          fi

          echo "Changed crates found:"
          echo "$CHANGED_OUTPUT"
          echo "has_changes=true" >> $GITHUB_OUTPUT

          # Extract changed crate names and store in array
          CRATES_JSON="["
          FIRST=true

          for CRATE_PATH in crates/*/Cargo.toml; do
            CRATE_DIR=$(dirname "$CRATE_PATH")
            CRATE_NAME=$(basename "$CRATE_DIR")

            # Check if this crate was in the changed list
            if echo "$CHANGED_OUTPUT" | grep -q "$CRATE_NAME"; then
              # Extract version from Cargo.toml
              VERSION=$(grep -m1 '^version = ' "$CRATE_PATH" | sed 's/version = "\(.*\)"/\1/')

              if [ -z "$VERSION" ]; then
                echo "âš ï¸ Could not extract version for $CRATE_NAME, skipping..."
                continue
              fi

              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                CRATES_JSON="${CRATES_JSON},"
              fi

              CRATES_JSON="${CRATES_JSON}{\"name\":\"${CRATE_NAME}\",\"version\":\"${VERSION}\"}"
              echo "ðŸ“¦ Will check: $CRATE_NAME v$VERSION"
            fi
          done

          CRATES_JSON="${CRATES_JSON}]"

          if [ "$CRATES_JSON" = "[]" ]; then
            echo "No crates to check."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "crates_json=$CRATES_JSON" >> $GITHUB_OUTPUT
          fi

      - name: Run dry-run publish for changed crates
        if: steps.detect-crates.outputs.has_changes == 'true'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          CRATES_JSON='${{ steps.detect-crates.outputs.crates_json }}'

          echo "::group::Running dry-run publish for changed crates"

          CRATE_COUNT=$(echo "$CRATES_JSON" | jq '. | length')
          CURRENT=0
          FAILED_CRATES=""
          ALL_SUCCESS=true

          echo "$CRATES_JSON" | jq -c '.[]' | while read -r crate; do
            CURRENT=$((CURRENT + 1))
            CRATE_NAME=$(echo "$crate" | jq -r '.name')
            VERSION=$(echo "$crate" | jq -r '.version')

            echo ""
            echo "[$CURRENT/$CRATE_COUNT] Checking $CRATE_NAME v$VERSION..."
            echo ""

            # Run dry-run
            if cargo ws publish --dry-run -p "$CRATE_NAME"; then
              echo "âœ… Dry-run passed for $CRATE_NAME v$VERSION"
            else
              echo "âŒ Dry-run failed for $CRATE_NAME v$VERSION"
              FAILED_CRATES="${FAILED_CRATES}${CRATE_NAME} "
              ALL_SUCCESS=false
            fi
          done

          echo "::endgroup::"

          if [ "$ALL_SUCCESS" = false ]; then
            echo "::error::Dry-run publish failed for: $FAILED_CRATES"
            exit 1
          fi

          echo "::notice::All dry-run checks passed successfully"

      - name: Summary
        if: always() && steps.detect-crates.outputs.has_changes == 'true'
        run: |
          CRATES_JSON='${{ steps.detect-crates.outputs.crates_json }}'

          {
            echo "## ðŸ“‹ Dry-Run Publish Check"
            echo ""
            echo "The following crates were validated for publishing:"
            echo ""
            echo "$CRATES_JSON" | jq -r '.[] | "- \`\(.name)\` v\(.version)"'
            echo ""
            echo "### Next Steps"
            echo ""
            echo "If all checks passed, this PR is ready to merge."
            echo "Upon merge, the \`publish-on-merge\` workflow will:"
            echo "1. Publish these crates to crates.io"
            echo "2. Create GitHub Releases"
            echo "3. Push release tags"
          } >> $GITHUB_STEP_SUMMARY

      - name: No changes summary
        if: always() && steps.detect-crates.outputs.has_changes == 'false'
        run: |
          {
            echo "## â„¹ï¸ No Crates to Publish"
            echo ""
            echo "No crates have changed since the last release."
            echo ""
            echo "**Note:** This PR has the \`release\` label but no crates need publishing."
            echo "Consider removing the \`release\` label if this is not a release PR."
          } >> $GITHUB_STEP_SUMMARY
