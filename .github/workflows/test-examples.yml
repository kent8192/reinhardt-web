name: Test Examples

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
  workflow_dispatch:

concurrency:
  group: test-examples-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  # Check if PR branch is behind base branch.
  # When out-of-date, skip all jobs to save runner costs.
  # The PR author should update the branch before CI runs.
  check-branch-status:
    name: Check Branch Status
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    outputs:
      is-behind: ${{ steps.check.outputs.is-behind }}
    steps:
      - name: Check if PR branch is behind base
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.repos.compareCommitsWithBasehead({
              owner: context.repo.owner,
              repo: context.repo.repo,
              basehead: `${context.payload.pull_request.base.ref}...${context.payload.pull_request.head.ref}`,
            });
            const isBehind = data.behind_by > 0;
            core.setOutput('is-behind', isBehind.toString());
            if (isBehind) {
              core.warning(
                `PR branch is ${data.behind_by} commit(s) behind ` +
                `${context.payload.pull_request.base.ref}. ` +
                `Skipping CI â€” please update your branch.`
              );
            }

  test-local-examples:
    name: Test ${{ matrix.example }}
    needs: [check-branch-status]
    if: >-
      ${{
        github.event.action != 'closed' &&
        (github.event_name != 'pull_request' || needs.check-branch-status.outputs.is-behind != 'true')
      }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        example:
          - examples-hello-world
          - examples-rest-api
          - examples-database-integration
          - examples-tutorial-basis
          - examples-tutorial-rest
          - examples-github-issues
          - examples-twitter

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@1.91.1
        with:
          components: rustfmt, clippy

      - name: Setup protoc
        uses: ./.github/actions/setup-protoc

      - name: Cache Cargo Registry
        uses: actions/cache@v5
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Cargo Git
        uses: actions/cache@v5
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Target
        uses: actions/cache@v5
        with:
          path: target
          key: ${{ runner.os }}-target-${{ matrix.example }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: Install reinhardt-admin
        run: cargo install --path crates/reinhardt-admin-cli

      - name: Setup local development config
        run: cp examples/.cargo/config.local.toml examples/.cargo/config.toml

      - name: Check Format
        working-directory: examples/${{ matrix.example }}
        run: cargo make fmt-check

      - name: Clippy
        working-directory: examples/${{ matrix.example }}
        run: cargo make clippy-check

      - name: Build
        working-directory: examples/${{ matrix.example }}
        run: cargo build --all-features

      - name: Test
        working-directory: examples/${{ matrix.example }}
        run: cargo nextest run --all-features

      - name: Doc Test
        working-directory: examples/${{ matrix.example }}
        run: cargo test --doc --all-features
