name: TODO Check

on:
  workflow_call:
    inputs:
      runner:
        description: 'Runner label JSON'
        type: string
        default: '"ubuntu-latest"'
      cargo-build-jobs:
        description: "Parallel cargo build jobs"
        type: string
        default: "1"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_TARGET_DIR: /tmp/cargo_target
  CARGO_INCREMENTAL: 0
  CARGO_BUILD_JOBS: ${{ inputs.cargo-build-jobs || '1' }}

jobs:
  todo-check:
    name: Scan for unresolved TODO/FIXME
    if: github.event_name == 'pull_request' && github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Semgrep TODO/FIXME scan
        run: semgrep ci --config .semgrep/ --metrics off

  clippy-todo-check:
    name: Clippy TODO/unimplemented/dbg lint
    runs-on: ${{ fromJSON(inputs.runner || '"ubuntu-latest"') }}
    timeout-minutes: 30
    steps:
      - name: Free Disk Space (Ubuntu)
        if: ${{ !contains(inputs.runner || '', 'self-hosted') }}
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Rust with clippy
        uses: ./.github/actions/setup-rust
        with:
          components: clippy

      - name: Setup protoc
        uses: ./.github/actions/setup-protoc

      - name: Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: Run clippy TODO check
        run: cargo make clippy-todo-check
