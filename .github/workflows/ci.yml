name: CI

on:
  push:
    branches:
      - main
  pull_request:
    # Run CI on PRs targeting any branch

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0

jobs:
  # Verify PR branch is up to date with the base branch before running CI.
  # Only runs on pull_request events; skipped for push to main.
  # If the branch is out of date, this job fails and all subsequent jobs are skipped.
  branch-up-to-date:
    name: Branch Up-to-Date Check
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR branch is up to date with base branch
        env:
          GH_TOKEN: ${{ github.token }}
          BASE_REF: ${{ github.base_ref }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          REPO: ${{ github.repository }}
        run: |
          # Use BASE_REF (branch name) instead of base SHA to ensure comparison
          # against the current HEAD of the base branch, not a potentially stale SHA.
          STATUS=$(gh api "repos/${REPO}/compare/${BASE_REF}...${HEAD_SHA}" --jq '.status')
          echo "Branch comparison status: ${STATUS}"
          if [[ "${STATUS}" == "behind" || "${STATUS}" == "diverged" ]]; then
            echo "::error::This branch is out of date with the base branch (${BASE_REF})."
            echo "::error::Please update your branch by merging or rebasing from the base branch before CI can run."
            exit 1
          fi
          echo "Branch is up to date with ${BASE_REF}."

  # Call all reusable workflows
  check:
    name: Check
    needs: [branch-up-to-date]
    if: needs.branch-up-to-date.result == 'success' || needs.branch-up-to-date.result == 'skipped'
    uses: ./.github/workflows/check.yml

  fmt:
    name: Format
    needs: [branch-up-to-date]
    if: needs.branch-up-to-date.result == 'success' || needs.branch-up-to-date.result == 'skipped'
    uses: ./.github/workflows/fmt.yml

  clippy:
    name: Clippy
    needs: [branch-up-to-date]
    if: needs.branch-up-to-date.result == 'success' || needs.branch-up-to-date.result == 'skipped'
    uses: ./.github/workflows/clippy.yml

  publish-check:
    name: Publish Check
    needs: [branch-up-to-date]
    if: needs.branch-up-to-date.result == 'success' || needs.branch-up-to-date.result == 'skipped'
    uses: ./.github/workflows/publish-check.yml

  todo-check:
    name: TODO Check
    needs: [branch-up-to-date]
    if: needs.branch-up-to-date.result == 'success' || needs.branch-up-to-date.result == 'skipped'
    uses: ./.github/workflows/todo-check.yml

  release-dry-run:
    name: Release Dry-Run
    needs: [branch-up-to-date]
    if: >-
      (needs.branch-up-to-date.result == 'success' ||
      needs.branch-up-to-date.result == 'skipped') &&
      !startsWith(github.head_ref || '', 'release-plz-')
    uses: ./.github/workflows/release-plz-dry-run.yml

  # All tests run in parallel after lightweight checks
  # Note: Each job runs on its own runner (no shared disk), so parallel execution is safe
  # Integration tests are split into intra-crate and cross-crate to reduce disk usage per job
  unit-test:
    name: Unit Tests
    uses: ./.github/workflows/unit-test.yml
    needs: [check, fmt, clippy]
    secrets: inherit

  intra-crate-integration-test:
    name: Intra-Crate Integration Tests
    uses: ./.github/workflows/intra-crate-integration-test.yml
    needs: [check, fmt, clippy]
    secrets: inherit

  cross-crate-integration-test:
    name: Cross-Crate Integration Tests
    uses: ./.github/workflows/cross-crate-integration-test.yml
    needs: [check, fmt, clippy]
    secrets: inherit

  doc-test:
    name: Documentation Tests
    uses: ./.github/workflows/doc-test.yml
    needs: [check, fmt, clippy]
    secrets: inherit

  ui-test:
    name: UI Tests
    uses: ./.github/workflows/ui-test.yml
    needs: [check, fmt, clippy]
    secrets: inherit

  examples-test:
    name: Examples Tests
    uses: ./.github/workflows/examples-test.yml
    needs: [check, fmt, clippy]
    secrets: inherit

  # All jobs must pass
  ci-success:
    name: CI Success
    if: always()
    runs-on: ubuntu-latest
    needs:
      - branch-up-to-date
      - check
      - fmt
      - clippy
      - publish-check
      - todo-check
      - release-dry-run
      - unit-test
      - intra-crate-integration-test
      - cross-crate-integration-test
      - doc-test
      - examples-test
      - ui-test
    steps:
      - name: Verify all required checks passed
        env:
          BRANCH_CHECK: ${{ needs.branch-up-to-date.result }}
          CHECK_RESULT: ${{ needs.check.result }}
          FMT_RESULT: ${{ needs.fmt.result }}
          CLIPPY_RESULT: ${{ needs.clippy.result }}
          PUBLISH_CHECK_RESULT: ${{ needs.publish-check.result }}
          TODO_CHECK_RESULT: ${{ needs.todo-check.result }}
          UNIT_TEST_RESULT: ${{ needs.unit-test.result }}
          INTRA_CRATE_RESULT: ${{ needs.intra-crate-integration-test.result }}
          CROSS_CRATE_RESULT: ${{ needs.cross-crate-integration-test.result }}
          DOC_TEST_RESULT: ${{ needs.doc-test.result }}
          EXAMPLES_TEST_RESULT: ${{ needs.examples-test.result }}
          UI_TEST_RESULT: ${{ needs.ui-test.result }}
          DRY_RUN_RESULT: ${{ needs.release-dry-run.result }}
        run: |
          # branch-up-to-date check: failure means PR branch is out of date
          if [[ "${BRANCH_CHECK}" == "failure" ]]; then
            echo "::error::PR branch is out of date with the base branch. Please update your branch and re-run CI."
            exit 1
          fi

          required_results=(
            "${CHECK_RESULT}"
            "${FMT_RESULT}"
            "${CLIPPY_RESULT}"
            "${PUBLISH_CHECK_RESULT}"
            "${TODO_CHECK_RESULT}"
            "${UNIT_TEST_RESULT}"
            "${INTRA_CRATE_RESULT}"
            "${CROSS_CRATE_RESULT}"
            "${DOC_TEST_RESULT}"
            "${EXAMPLES_TEST_RESULT}"
            "${UI_TEST_RESULT}"
          )
          for result in "${required_results[@]}"; do
            if [[ "$result" != "success" ]]; then
              echo "::error::Required CI check failed: $result"
              exit 1
            fi
          done
          # release-dry-run is skipped on release-plz branches (expected)
          if [[ "${DRY_RUN_RESULT}" != "success" && "${DRY_RUN_RESULT}" != "skipped" ]]; then
            echo "::error::Release dry-run failed: ${DRY_RUN_RESULT}"
            exit 1
          fi
          echo "All CI checks passed!"
