# Nextest Configuration for Reinhardt
#
# This configuration addresses flaky test issues during parallel execution,
# particularly for TestContainers-based database integration tests.

[profile.default]
# Limit concurrent tests to prevent Docker resource exhaustion
# (file descriptors, memory, Docker daemon connection pool)
max-tests-per-run = 8

# Increase timeout for database operations
# Database container initialization can be slow under high load
slow-timeout = "60s"
timeout = "120s"

# Enable retries for flaky infrastructure tests
# Uses exponential backoff to handle transient failures
retries = { backoff = "exponential", max-retries = 2, seed = 12345 }

# Separate integration tests into dedicated worker threads
# Reduces resource contention for database-dependent tests
[[profile.default.overrides]]
filter = 'test(integration)'
threads-required = 1

# Database tests in examples must run serially due to global state
# cargo-nextest runs tests in separate processes, so serial_test crate doesn't work
# Instead, we force these tests to run one at a time via nextest configuration
[[profile.default.overrides]]
filter = 'binary(examples-database-integration) & test(test_)'
test-threads = 1

# Session database integration tests require serial execution
# They share an in-memory SQLite database that doesn't persist across processes
[[profile.default.overrides]]
filter = 'test(database_backend_integration)'
test-threads = 1

# Trybuild compile-fail tests need longer timeout
# The compiler takes significant time to produce error messages
[[profile.default.overrides]]
filter = 'test(compile_fail) | test(trybuild) | binary_id(~macro_compile)'
timeout = "300s"

# JUnit output for CI/CD integration
[profile.default.junit]
path = "target/nextest/junit.xml"
