//! Tests for response utility functions
//!
//! These tests verify response handling utilities including:
//! - Response status checks
//! - Header validation
//! - Body parsing (text, JSON)
//! - Redirect handling
//! - Content-type detection
//!
//! Based on Django's response utilities

use bytes::Bytes;
use http::{HeaderMap, HeaderValue, StatusCode};
use reinhardt_test::TestResponse;
use serde_json::json;

#[test]
fn test_response_status() {
    // Test: Get response status code
    let response = TestResponse::with_body(StatusCode::OK, HeaderMap::new(), Bytes::new());

    assert_eq!(response.status(), StatusCode::OK);
    assert_eq!(response.status_code(), 200);
}

#[test]
fn test_response_is_success() {
    // Test: Check if response is successful (2xx)
    let ok_response = TestResponse::with_body(StatusCode::OK, HeaderMap::new(), Bytes::new());
    assert!(ok_response.is_success());

    let created_response =
        TestResponse::with_body(StatusCode::CREATED, HeaderMap::new(), Bytes::new());
    assert!(created_response.is_success());

    let bad_request =
        TestResponse::with_body(StatusCode::BAD_REQUEST, HeaderMap::new(), Bytes::new());
    assert!(!bad_request.is_success());
}

#[test]
fn test_response_is_client_error() {
    // Test: Check if response is client error (4xx)
    let bad_request =
        TestResponse::with_body(StatusCode::BAD_REQUEST, HeaderMap::new(), Bytes::new());
    assert!(bad_request.is_client_error());

    let not_found = TestResponse::with_body(StatusCode::NOT_FOUND, HeaderMap::new(), Bytes::new());
    assert!(not_found.is_client_error());

    let ok_response = TestResponse::with_body(StatusCode::OK, HeaderMap::new(), Bytes::new());
    assert!(!ok_response.is_client_error());
}

#[test]
fn test_response_is_server_error() {
    // Test: Check if response is server error (5xx)
    let server_error = TestResponse::with_body(
        StatusCode::INTERNAL_SERVER_ERROR,
        HeaderMap::new(),
        Bytes::new(),
    );
    assert!(server_error.is_server_error());

    let service_unavailable = TestResponse::with_body(
        StatusCode::SERVICE_UNAVAILABLE,
        HeaderMap::new(),
        Bytes::new(),
    );
    assert!(service_unavailable.is_server_error());

    let ok_response = TestResponse::with_body(StatusCode::OK, HeaderMap::new(), Bytes::new());
    assert!(!ok_response.is_server_error());
}

#[test]
fn test_response_text() {
    // Test: Get response body as text
    let body = Bytes::from("Hello, World!");
    let response = TestResponse::with_body(StatusCode::OK, HeaderMap::new(), body);

    assert_eq!(response.text(), "Hello, World!");
}

#[test]
fn test_response_json() {
    // Test: Parse response body as JSON
    let data = json!({"name": "test", "value": 42});
    let body = Bytes::from(serde_json::to_vec(&data).unwrap());
    let response = TestResponse::with_body(StatusCode::OK, HeaderMap::new(), body);

    let parsed: serde_json::Value = response.json().unwrap();
    assert_eq!(parsed["name"], "test");
    assert_eq!(parsed["value"], 42);
}

#[test]
fn test_response_json_value() {
    // Test: Parse response body as generic JSON value
    let data = json!({"items": [1, 2, 3], "total": 3});
    let body = Bytes::from(serde_json::to_vec(&data).unwrap());
    let response = TestResponse::with_body(StatusCode::OK, HeaderMap::new(), body);

    let parsed = response.json_value().unwrap();
    assert_eq!(parsed["total"], 3);
    assert_eq!(parsed["items"].as_array().unwrap().len(), 3);
}

#[test]
fn test_response_content_type() {
    // Test: Get content-type header
    let mut headers = HeaderMap::new();
    headers.insert(
        "content-type",
        HeaderValue::from_static("application/json; charset=utf-8"),
    );

    let response = TestResponse::with_body(StatusCode::OK, headers, Bytes::new());

    assert_eq!(
        response.content_type(),
        Some("application/json; charset=utf-8")
    );
}

#[test]
fn test_response_headers() {
    // Test: Access response headers
    let mut headers = HeaderMap::new();
    headers.insert("x-custom-header", HeaderValue::from_static("custom-value"));
    headers.insert("x-request-id", HeaderValue::from_static("12345"));

    let response = TestResponse::with_body(StatusCode::OK, headers, Bytes::new());

    assert_eq!(
        response.headers().get("x-custom-header").unwrap(),
        "custom-value"
    );
    assert_eq!(response.headers().get("x-request-id").unwrap(), "12345");
}

#[test]
fn test_response_redirect_status() {
    // Test: Redirect status codes
    let redirect = TestResponse::with_body(StatusCode::FOUND, HeaderMap::new(), Bytes::new());
    assert!(redirect.status().is_redirection());

    let permanent_redirect = TestResponse::with_body(
        StatusCode::MOVED_PERMANENTLY,
        HeaderMap::new(),
        Bytes::new(),
    );
    assert!(permanent_redirect.status().is_redirection());
}

#[test]
fn test_response_empty_body() {
    // Test: Handle empty response body
    let response = TestResponse::with_body(StatusCode::NO_CONTENT, HeaderMap::new(), Bytes::new());

    assert_eq!(response.body().len(), 0);
    assert_eq!(response.text(), "");
}

#[test]
fn test_response_body_bytes() {
    // Test: Get raw body bytes
    let body = Bytes::from(vec![0x48, 0x65, 0x6c, 0x6c, 0x6f]); // "Hello"
    let response = TestResponse::with_body(StatusCode::OK, HeaderMap::new(), body.clone());

    assert_eq!(response.body(), &body);
    assert_eq!(response.body().len(), 5);
}

#[test]
fn test_response_multiple_headers_same_name() {
    // Test: Handle multiple headers with the same name
    let mut headers = HeaderMap::new();
    headers.insert("set-cookie", HeaderValue::from_static("session=abc123"));
    headers.append("set-cookie", HeaderValue::from_static("user=john"));

    let response = TestResponse::with_body(StatusCode::OK, headers, Bytes::new());

    let cookies: Vec<_> = response.headers().get_all("set-cookie").iter().collect();
    assert_eq!(cookies.len(), 2);
}

#[test]
fn test_response_utf8_text() {
    // Test: Handle UTF-8 text in response body
    let body = Bytes::from("こんにちは世界"); // Japanese text
    let response = TestResponse::with_body(StatusCode::OK, HeaderMap::new(), body);

    assert_eq!(response.text(), "こんにちは世界");
}
