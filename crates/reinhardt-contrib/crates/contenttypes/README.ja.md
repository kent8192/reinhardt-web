# reinhardt-contenttypes

汎用リレーションとコンテンツタイプフレームワーク

## 概要

モデル間の汎用的な関係を扱うためのフレームワークです。モデルが他のあらゆるモデルタイプを動的に参照することを可能にします。

コメント、タグ、アクティビティストリームなど、複数のモデルタイプに関連付けられる柔軟なシステムを構築するのに便利です。

## 機能

### 実装済み ✓

#### コアコンテンツタイプシステム

- **ContentType Model** - アプリラベルとモデル名を持つモデルタイプの表現
  - `ContentType::new()` - 新しいコンテンツタイプを作成
  - `ContentType::with_id()` - コンテンツタイプIDを設定
  - `natural_key()` - ナチュラルキー用の(app_label, model)タプルを取得
  - `qualified_name()` - 完全修飾名を取得（例: "blog.Post"）
  - `Serialize`, `Deserialize`, `PartialEq`, `Eq`, `Hash`, `Clone`を実装

#### コンテンツタイプレジストリ（ランタイム）

- **ContentTypeRegistry** - スレッドセーフなキャッシングを備えたランタイムコンテンツタイプ管理
  - `register()` - 自動ID割り当てで新しいコンテンツタイプを登録
  - `get()` - アプリラベルとモデル名でコンテンツタイプを取得
  - `get_by_id()` - IDでコンテンツタイプを取得
  - `get_or_create()` - 既存のコンテンツタイプを取得または新規作成
  - `all()` - すべての登録済みコンテンツタイプを一覧表示
  - `clear()` - レジストリをクリア（主にテスト用）
  - `RwLock`による並行アクセス対応のスレッドセーフ実装
  - 登録済みタイプの自動ID生成

#### グローバルコンテンツタイプレジストリ

- **CONTENT_TYPE_REGISTRY** - グローバルシングルトンレジストリインスタンス
  - 初期化のため`once_cell::Lazy`を使用
  - 一貫したコンテンツタイプ管理のためにアプリケーション全体で共有

#### ジェネリック外部キー

- **GenericForeignKey** - 任意のモデルタイプを参照するフィールド
  - `new()` - 空のジェネリック外部キーを作成
  - `set()` - コンテンツタイプとオブジェクトIDを設定
  - `get_content_type()` - 関連付けられたコンテンツタイプを取得
  - `is_set()` - コンテンツタイプとオブジェクトIDの両方が設定されているかチェック
  - `clear()` - コンテンツタイプとオブジェクトIDをクリア
  - `Default`, `Serialize`, `Deserialize`, `Clone`を実装

#### 型安全API（コンパイル時）

- **ModelType Trait** - コンパイル時の型安全なコンテンツタイプ定義
  - `APP_LABEL` - アプリラベルの関連定数
  - `MODEL_NAME` - モデル名の関連定数
  - `ContentTypeRegistry`の型安全なメソッド:
    - `get_typed<M: ModelType>()` - 型安全な取得
    - `get_or_create_typed<M: ModelType>()` - 型安全な取得または作成
    - `register_typed<M: ModelType>()` - 型安全な登録
  - `GenericForeignKey`の型安全なメソッド:
    - `set_typed<M: ModelType>()` - モデルタイプを使った型安全な設定

#### ジェネリックリレーションクエリ

- **GenericRelatable Trait** - ジェネリックリレーションのターゲットになれるモデル用のトレイト
  - `get_content_type()` - モデルのコンテンツタイプを取得
  - `get_object_id()` - インスタンスのオブジェクトIDを取得

- **GenericRelationQuery** - ジェネリックリレーションクエリを構築するヘルパー
  - `new()` - 特定のコンテンツタイプのクエリを作成
  - `add_object()` - クエリにオブジェクトIDを追加
  - `to_sql()` - 関連オブジェクトを取得するSQLクエリを生成

### 予定

#### データベース統合

- 自動ContentTypeテーブル作成とマイグレーション
- データベースへのContentTypeインスタンスの永続化
- データベースベースのコンテンツタイプルックアップ
- コンテンツタイプのマルチデータベースサポート
- GenericForeignKeyフィールドの外部キー制約

#### ORM統合

- モデル用のジェネリックリレーションフィールド（`GenericRelation`）
- 逆ジェネリックリレーションクエリ
- ジェネリックリレーションのプリフェッチサポート
- 効率的なジェネリックリレーションクエリのためのQuerySet統合
- ジェネリックリレーションのフィルタリングとソート

#### パーミッションシステム統合

- コンテンツタイプとパーミッションの関連付け
- パーミッションチェックユーティリティ
- コンテンツタイプベースの認可

#### 高度な機能

- コンテンツタイプショートカット（ジェネリックオブジェクトのURL解決）
- コンテンツタイプビューミックスイン
- ジェネリックリレーション用の管理インターフェース統合
- モデル削除時の自動コンテンツタイプクリーンアップ
- コンテンツタイプのリネームとマイグレーションサポート

#### 管理コマンド

- コンテンツタイプの`dumpdata`/`loaddata`サポート
- コンテンツタイプ同期コマンド
- コンテンツタイプ検査ユーティリティ
