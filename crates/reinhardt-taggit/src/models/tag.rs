//! Tag model definition
//!
//! Core tag entity with normalized name and URL-friendly slug.
//! Slug is auto-generated from name via `Tag::from_name()`,
//! or can be explicitly specified via `Tag::new()`.

use chrono::{DateTime, Utc};
use reinhardt_core::macros::model;
use serde::{Deserialize, Serialize};

/// Core tag entity
///
/// Represents a tag with a normalized name and URL-friendly slug.
/// Tags are globally unique by name (case-insensitive if configured).
///
/// Use `Tag::from_name()` to create a tag with an auto-generated slug,
/// or `Tag::new()` to specify both name and slug explicitly.
///
/// # Database Schema
///
/// ```sql
/// CREATE TABLE tags (
///     id BIGSERIAL PRIMARY KEY,
///     name VARCHAR(255) NOT NULL,
///     slug VARCHAR(255) NOT NULL,
///     created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
///     UNIQUE(name),
///     UNIQUE(slug)
/// );
/// ```
///
/// # Examples
///
/// ```rust,ignore
/// use reinhardt_taggit::Tag;
///
/// // Auto-generate slug from name
/// let tag = Tag::from_name("Rust Programming");
/// assert_eq!(tag.slug, "rust-programming");
///
/// // Explicit slug
/// let tag = Tag::new("Rust Programming", "rust-prog");
/// assert_eq!(tag.slug, "rust-prog");
/// ```
#[model(app_label = "taggit", table_name = "tags")]
#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]
pub struct Tag {
	/// Primary key
	#[field(primary_key = true)]
	pub id: Option<i64>,

	/// Normalized tag name (unique, case-insensitive if configured)
	#[field(max_length = 255, unique = true)]
	pub name: String,

	/// URL-friendly slug (unique, auto-generated from name)
	#[field(max_length = 255, unique = true)]
	pub slug: String,

	/// Creation timestamp
	#[field(auto_now_add = true)]
	pub created_at: DateTime<Utc>,
}

// NOTE: `new` function is automatically generated by #[model] macro

impl Tag {
	/// Create a new tag with an auto-generated slug from the name
	///
	/// The slug is generated using the `slug` crate, which converts
	/// unicode text to an ASCII URL-friendly slug.
	///
	/// # Examples
	///
	/// ```rust,ignore
	/// use reinhardt_taggit::Tag;
	///
	/// let tag = Tag::from_name("Rust Programming");
	/// assert_eq!(tag.name, "Rust Programming");
	/// assert_eq!(tag.slug, "rust-programming");
	/// ```
	pub fn from_name(name: impl Into<String>) -> Self {
		let name = name.into();
		let slug_val = slug::slugify(&name);
		Self::new(&name, &slug_val)
	}
}

#[cfg(test)]
mod tests {
	use super::*;

	#[test]
	fn test_tag_creation() {
		let tag = Tag::new("rust", "rust");
		assert_eq!(tag.name, "rust");
		assert_eq!(tag.slug, "rust");
		assert!(tag.id.is_none());
	}

	#[test]
	fn test_tag_from_name_simple() {
		let tag = Tag::from_name("rust");
		assert_eq!(tag.name, "rust");
		assert_eq!(tag.slug, "rust");
		assert!(tag.id.is_none());
	}

	#[test]
	fn test_tag_from_name_with_spaces() {
		let tag = Tag::from_name("Rust Programming");
		assert_eq!(tag.name, "Rust Programming");
		assert_eq!(tag.slug, "rust-programming");
	}

	#[test]
	fn test_tag_from_name_with_special_chars() {
		let tag = Tag::from_name("C++ & Rust!");
		assert_eq!(tag.name, "C++ & Rust!");
		// slug crate converts special chars to hyphens
		assert!(!tag.slug.is_empty());
		assert!(!tag.slug.contains(' '));
	}
}
