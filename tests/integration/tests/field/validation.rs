//! Field Validation Tests
//!
//! Tests application-level validation via the Document::validate() method,
//! generated by the `#[document(...)]` macro.

use bson::oid::ObjectId;
use reinhardt_db::nosql::document::Document;
use reinhardt_db::nosql::error::{OdmError, ValidationError};
use reinhardt_db_macros::document;
use rstest::rstest;
use serde::{Deserialize, Serialize};

/// Test document with validation constraints
#[document(collection = "test_validation", backend = "mongodb")]
#[derive(Serialize, Deserialize, Debug)]
struct ValidationTest {
	#[field(primary_key)]
	id: Option<ObjectId>,
	#[field(required)]
	required_field: String,
	#[field(min = 0, max = 100)]
	score: i32,
}

/// Test that an empty required field fails validation
///
/// Verifies that:
/// 1. validate() returns a Required error for empty String fields with #[field(required)]
#[rstest]
fn test_required_validation() {
	// Arrange
	let doc = ValidationTest {
		id: None,
		required_field: String::new(),
		score: 50,
	};

	// Act
	let result = doc.validate();

	// Assert
	assert!(result.is_err());
	let err = result.unwrap_err();
	assert!(
		matches!(err, OdmError::Validation(ValidationError::Required(field)) if field == "required_field")
	);
}

/// Test that min/max constraints are enforced by validation
///
/// Verifies that:
/// 1. Values below min trigger OutOfRange error
/// 2. Values above max trigger OutOfRange error
#[rstest]
fn test_min_max_validation() {
	// Arrange: value below minimum
	let doc_below = ValidationTest {
		id: None,
		required_field: "valid".to_string(),
		score: -1,
	};

	// Act
	let result_below = doc_below.validate();

	// Assert: below min triggers OutOfRange
	assert!(result_below.is_err());
	assert!(matches!(
		result_below.unwrap_err(),
		OdmError::Validation(ValidationError::OutOfRange {
			field: "score",
			min: 0,
			max: 100
		})
	));

	// Arrange: value above maximum
	let doc_above = ValidationTest {
		id: None,
		required_field: "valid".to_string(),
		score: 101,
	};

	// Act
	let result_above = doc_above.validate();

	// Assert: above max triggers OutOfRange
	assert!(result_above.is_err());
	assert!(matches!(
		result_above.unwrap_err(),
		OdmError::Validation(ValidationError::OutOfRange {
			field: "score",
			min: 0,
			max: 100
		})
	));
}

/// Test that valid data passes validation
///
/// Verifies that:
/// 1. A document with all valid fields passes validate() without error
#[rstest]
fn test_valid_data_passes() {
	// Arrange
	let doc = ValidationTest {
		id: None,
		required_field: "valid_value".to_string(),
		score: 50,
	};

	// Act
	let result = doc.validate();

	// Assert
	assert!(result.is_ok());
}

/// Test that validation_schema() returns a proper BSON validation schema
///
/// Verifies that:
/// 1. validation_schema() returns Some
/// 2. Schema contains "bsonType", "properties", and "required" keys
#[rstest]
fn test_validation_schema_generated() {
	// Arrange & Act
	let schema = ValidationTest::validation_schema();

	// Assert
	assert!(schema.is_some());
	let schema = schema.unwrap();
	assert!(schema.contains_key("bsonType"));
	assert!(schema.contains_key("properties"));
	assert!(schema.contains_key("required"));
}
